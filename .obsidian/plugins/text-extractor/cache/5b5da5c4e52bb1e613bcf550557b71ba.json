{"path":".obsidian/plugins/text-extractor/cache/5b5da5c4e52bb1e613bcf550557b71ba.json","text":"Exercise Guide Contents INTRODUCTION ....................................................................................................................................................... 4 USING SKYTAP ............................................................................................................................................................................................... 4 INTERNATIONAL USERS ............................................................................................................................................................................... 6 SCENARIO ................................................................................................................................................................ 10 EPV INSTRUCTIONS .............................................................................................................................................. 11 VAULT INSTALLATION ........................................................................................................................................ 13 PREPARATION ............................................................................................................................................................................................... 13 VAULT SERVER INSTALLATION............................................................................................................................................................... 15 PRIVATEARK CLIENT INSTALLATION ................................................................................................................................................... 24 POST VAULT INSTALLATION .................................................................................................................................................................... 27 INSTALL PASSWORD VAULT WEB ACCESS .................................................................................................. 28 INSTALL IIS PRE-REQUISITE SOFTWARE USING AUTOMATIC PREREQUISITES SCRIPT ........................................................... 28 IMPORT TRUSTED CERTIFICATES FOR WEBHOSTING ....................................................................................................................... 29 REQUIRE HTTP OVER SSL (PVWA) ........................................................................................................................ 31 INSTALL PVWA ....................................................................................................................................................... 31 HARDENING THE CYBERARK PVWA SERVER ................................................................................................................................... 35 MANUAL HARDENING ................................................................................................................................................................................ 35 INSTALLATION AUTOMATION HARDENING ......................................................................................................................................... 37 Final Manual Hardening Configuration for PVWA Deployments........................................................................... 38 INSTALL THE PRIVATEARK CLIENT ON THE COMPONENT SERVER .............................................................................................. 38 AUTOMATED HARDENING: GROUP POLICY ENFORCEMENT .......................................................................................................... 39 INSTALL CPM .......................................................................................................................................................... 40 INSTALL 1ST CPM ..................................................................................................................................................... 40 POST CPM INSTALLATION ........................................................................................................................................................................ 43 HARDEN THE CPM SERVER(S) .................................................................................................................................. 43 INSTALL PSM .......................................................................................................................................................... 46 INSTALL A STANDALONE PSM SERVER ......................................................................................................... 47 PSM INSTALLATION PREREQUISITES .................................................................................................................................................... 47 PSM INSTALLATION ................................................................................................................................................................................... 51 Update RDS Certificate ........................................................................................................................................... 56 INTEGRATIONS ...................................................................................................................................................... 57 LDAP AUTHENTICATION (OVER SSL) ...................................................................................................................... 57 USER MANAGEMENT............................................................................................................................................ 66 known the Players .................................................................................................................................................... 66 Create LADAP Users .............................................................................................................................................. 67 Create IT Managers Group ...................................................................................................................................... 70 Create Service Accounts .......................................................................................................................................... 71 Adding Users to LDAP Groups or AD Groups ....................................................................................................... 73 Create Accounts for Discovery and Onboarding ..................................................................................................... 75 EPV TESTING AND VALIDATION ...................................................................................................................... 76 Securing Windows Domain Accounts ..................................................................................................................... 77 Platform Management.............................................................................................................................................. 77 Editing Master Policy .............................................................................................................................................. 81 Add Exceptions ........................................................................................................................................................ 83 Safe Management .................................................................................................................................................... 85 Page 2 Account Management ....................................................................................................................................................................................... 88 ADD the Reconcilation Account ............................................................................................................................... 89 ADD the Discovery Account .................................................................................................................................... 92 Securing Unix SSH Accounts .................................................................................................................................. 93 Vault Administration Tasks - Mike ......................................................................................................................... 93 Configuring The Master Policy ............................................................................................................................... 96 Safe Manager Tasks - Paul ...................................................................................................................................... 96 Creating Safe ........................................................................................................................................................... 97 Add Safe Member .................................................................................................................................................... 98 Adding a Linux Account........................................................................................................................................ 100 Test the New Account as Safe Manager ................................................................................................................ 104 Test the New Account as a Normal User ............................................................................................................... 106 Auditor Tasks ........................................................................................................................................................ 108 Securing Oracle Database Accounts ...................................................................................................................... 110 Duplicating a Platform ........................................................................................................................................... 110 Safe Member Tasks ............................................................................................................................................... 112 Adding Oracle Account ......................................................................................................................................... 113 LINKED ACCOUNTS ............................................................................................................................................ 114 Securing SSH Accounts Using a Logon Account .................................................................................................. 114 Securing Windows Server Local Accounts via Reconcile Account ...................................................................... 117 Creating a Safe ....................................................................................................................................................... 120 Adding an Account ................................................................................................................................................ 122 SECURING UNIX ACCOUNTS WITH SSH KEYS ........................................................................................... 124 Generating Key-Pair .............................................................................................................................................. 124 Verify You can login with the Private Key ............................................................................................................ 130 Duplicating a Platform – Vault Administrator Task .............................................................................................. 132 Add an Account with SSH key – Safe Manager Task ........................................................................................... 133 PRIVILED ACCESS WORKFLOWS ................................................................................................................... 134 Require Users To Specify Reason For Access ....................................................................................................... 124 Add Predefined Reason for Access ........................................................................................................................ 136 Testing Predefined Reasons for Access ................................................................................................................. 137 Require dual Control Access Approval ................................................................................................................. 138 Adding an Approver to a Safe ............................................................................................................................... 139 Testing Dual Control ............................................................................................................................................. 141 Exclusive Passwords with Automated Release and One-time Use ........................................................................ 144 Testing Exclusive Passwords ................................................................................................................................. 147 DISCOVERY AND ONBOARDING ..................................................................................................................... 151 configuring Automatic Onboarding Rule .............................................................................................................. 151 Configure and Run Windows Accounts Discovery ............................................................................................... 154 Manual Onboard Discovered Accounts ................................................................................................................. 160 PUU OR MULTIPLE ACCOUNTS ONBOARDING .......................................................................................... 163 Add Multiple Accounts from File .......................................................................................................................... 163 SECURE CONNECTION ....................................................................................................................................... 167 connect using PSM Ad-Hoc Connection ............................................................................................................... 167 PRIVILEGED SESSTION MANAGEMENT ....................................................................................................... 169 PSM Session Terminators ...................................................................................................................................... 169 Monitor Recordings ............................................................................................................................................... 171 Page 3 REMOTE CONTROL CLIENT ............................................................................................................................ 173 UNSUSPEND A SUSPEND USER ......................................................................................................................... 175 LOGIN WITH MASTER USER ............................................................................................................................177 REPORTS ................................................................................................................................................................ 178 Generating “Safe List” Report and User List” Report ........................................................................................... 180 CYBERARK VAULT BACKUP ............................................................................................................................ 182 ENABLE THE BACKUP AND DR USERS............................................................................................................................................... 182 INSTALL THE PRIVATEARK REPLICATOR COMPONENT ................................................................................................................ 185 CREATE A WINDOWS SCHEDULED TASK .......................................................................................................................................... 186 TESTING THE BACKUP/RESTORE PROCESS ....................................................................................................................................... 188 DISASTER RECOVERY ........................................................................................................................................ 190 INSTALL THE DISASTER RECOVERY MODULE ................................................................................................................................. 190 VALIDATE REPLICATION ........................................................................................................................................................................ 192 EXECUTE FAILBACK PROCEDURE USING MANUAL FAILOVER .................................................................................................. 196 (OPTIONAL) EXERCISES .................................................................................................................................... 200 JIT (JustIn Time) Access .......................................................................................................................................200 Page 4 Introduction Using Skytap Before beginning exercises, here are a few tips to help you navigate the labs more effectively. • Click directly on the screen icon to access the virtual machine directly in your browser Go to the section for International Users for instructions on changing the keyboard. 1. Click the large monitor icon to connect with the HTML 5 client. 2. Use the Ctrl-Alt-Del button on the tool bar to send a Ctrl-Alt-Del to the machine. 3. The clipboard icon will allow you to copy and paste text between your computer and your lab machine. Page 5 4. The full screen icon will resize your lab machine to match your computer’s screen settings to avoid scrolling. 5. You may need to adjust your bandwidth setting on slower connections. Page 6 International Users By default, the lab machines are configured to us a US English keyboard layout. If you use a machine from a country other than the US, you may experience odd behavior from your lab machines. The solution is to install the keyboard layout for your keyboard on our lab machines. Follow the process below to find and configure the correct keyboard layout for your keyboard. 6. From the Start Menu launch “Add a language.” 7. Click “Add a language.” Page 7 8. Select your language and click Next. Page 8 Note: If you use an alternate keyboard layout (e.g. AZERTY, Dvorak) you can click options next to your language to install that. Otherwise, close the Language window. 9. Deselect Speech and click Install. 10. Select the language desired and click the UP arrow to change the default language. Do not remove US English language as your instructor may need it if he/she connects to your machine. Page 9 11. In the system tray, click ENG, then choose your keyboard layout. You may switch back and forthbetween keyboard layouts. Page 10 Scenario The ACME Corporation has recently purchased CyberArk’s Privileged Access Management (PAM) Core suite of software. You have been assigned the task to guide and assist The ACME Corporation in its deployment and configuration of the CyberArk PAM software with the goal of meeting the business requirements. This document details the customer’s specific requirements regarding the use of PAM in their environment. CyberArk’s documentation online at docs.cyberark.com is available for reference to complete your tasks. All CyberArk documentation is available on the web at ‘https://docs.cyberark.com/’. This PAM I&C v12.1 Exercise guide provided by CyberArk University should be used in the training environment only. For production deployments use CyberArk published documentation at docs.cyberark.com for the version you are installing. Page 11 EPV Instructions The ACME Corporation has purchased CyberArk’s Privileged Access Management solution to protect and manage their privileged accounts. End users are required to authenticate to CyberArk using twofactor authentication. You are required to: 1. Install a standalone Vault 2. Install 2 PVWA Servers (Load Balanced, and configured for automatic failover to the DR vault) 3. Install 2 CPM Servers (one for managing Windows accounts and one for managing Unix and Oracle) 4. Install 2 PSM Servers in a Load Balanced configuration 5. Install 1 PSM for SSH Server 6. Install the Disaster Recovery and Vault Backup components 7. Integrate CyberArk with the Customer’s LDAP, SMTP and SIEM solutions 8. Implement 2 Factor Authentication 9. Test the PAM EPV implementation. Add test accounts on the following target systems; Windows Domain, Windows Server, Linux, and Oracle and execute password management and PSM operations. Default Passwords All user accounts including local Administrator and ACME.CORP domain accounts are Cyberark1. Network Resources The following table lists the network resources provisioned by ACME Corporation for the CyberArk PAM Suite of software. The Windows Domain Controller for ‘ACME.CORP’ must always be poweredon when working in your Skytap Lab environment. Network Server Name Is domain member? IP Address Windows DC01 Domain Controller ACME.CORP 10.0.0.2 Comp01A(PVWA) Yes 10.0.20.1 Comp01B (CPM) Yes 10.0.21.1 Comp01C (PSM) Yes 10.0.22.1 Comp01D ( Admin) Yes 10.0.23.1 Vault01A No. Workgroup 10.0.10.1 Page 12 DR No. Workgroup 10.0.14.1 Linux PSMP Linux 10.0.1.16 CentOS-target Linux 10.0.0.20 RADIUS Linux 10.0.0.6 Page 13 Objective: Preparation. It is important to copy all CyberArk software, License.xml and any other files needed to the Vault server prior to EPV installation and hardening. Note: Ensure that all Virtual Machines (VM’s) are started in your Skytap lab before proceeding, (except for the DR VM). Objective: A stand-alone Vault server only requires TCP/IPv4 for network communication. In preparation to install the Vault server software, we will first remove all NIC protocols, Vault Installation This exercise provides detailed instructions on installing the CyberArk Digital Vault server and clientsoftware and is broken down into three sections: • Preparation • Vault Server Installation • PrivateArk Client Installation Preparation 1. Sign in to the Vault01A server. Username Administrator; Password Cyberark1 2. Open File Explorer and navigate to the shared resource folder, “Z:\\”. If the Z: drive is not mapped, map Z: to “\\\\dc01\\shared”. a. Navigate to “Z:\\CyberArk PAM Solution\\v12.1\\”. Copy folders “\\Vault Installation Files” and “License and Operator Keys” to “C:\\CYBR_Files”. b. Do not copy any other folders or files. 1. Right click the Network icon in the system tray and select Open Network and Sharing Center. Page 14 2. Click Change adapter settings. 3. Right click on the Public Network Adapter and choose Properties. 4. Confirm Internet Protocol Version 6 (TCP/IPv6) is selected. 5. Select Internet Protocol Version 4 (TCP/IPv4) and select Properties. a. Ensure the static IP address (10.0.10.1), Subnet mask (255.255.0.0) and Default gateway (10.0.255.254) are defined. b. Remove all DNS server addresses and select the Advanced... button. c. In the DNS tab, deselect “Register this connections addresses in DNS”. d. In the WINS tab, deselect “Enable LMHOSTS lookup”. e. Select Disable NetBIOS over TCP/IP. f. Select OK twice to return to the Public Properties dialog. 6. Uninstall all services, clients and protocols except for Internet Protocol Version 4 (TCP/IPv4) and Internet Protocol Version 6 (TCP/IPv6). Page 15 Objective: This exercise provides detailed, step-by-step instructions on installing the CyberArk Digital Vault server and Private Ark Client software. On the lab server, the files copied from the shared drive in the pre-requisite steps are required to complete the Vault Server Installation 1. Sign into the Vault server as Administrator. Using File Explorer, navigate to “C:\\CYBR_Files\\VaultInstallation Files\\Server”. Right click on setup.exe and choose “Run as Administrator”. 2. Accept the default options on the next three windows, including your company name (e.g. CyberArk) on the Customer Information page. Page 16 3. Select the Standalone Vault Installation option to install the Vault as a stand-alone server. 4. Press Next to accept the default installation location. 5. Select Browse to select a custom Safes location. Change the drive letter ‘E:\\PrivateArk\\Safes’ as shown then select Next to continue. Page 17 Note: Because the software is configured to look for the license file on the DVD drive by default, you will probably receive an error message regarding the D: drive. 6. Select Browse to select a custom license file path. 7. Click OK and then Cancel on the Insert disc pop-up to browse to the correct location. Page 18 8. In the Choose folder pop-up, browse to “C:\\CYBR_Files\\License and Operator Keys\\License”,press OK and then press Next. 9. The same procedure is required for the Operator CD. Press Browse to select a custom Operator CD path. 10. You will receive the same error message regarding the D: drive. Click OK and then Cancel on the Insert disc pop-up to browse to the correct location. Page 19 Note: These files must be accessible to the PrivateArk Server service in order to start the Vault. A Hardware Security Module (HSM) is the recommended method for key storage. If these files are to be stored on the file system, it is highly recommended that the keys and encrypted files be stored on separate media. If stored on attached storage, the Operator Keys should be located on an NTFS drive. Note: If the Vault is installed on a virtual machine, storing Operator CD files on the file system is not recommended due to the lack of physical security. 11. Browse to the “C:\\CYBR_Files\\License and Operator Keys\\Operator CD” directory and click OK and then and press Next. Page 20 12. Enter the IP address(es) of your Component servers in the Remote Terminal IP Address field – 10.0.20.1,10.0.21.1 and Cyberark1 – in the password fields and press Next. 13. We will not be using Distributed Vaults with PSM in this lab. Select Next without selecting “Install the Distributed Vaults internal communication platform”. Page 21 14. Press Next to allow CyberArk to harden the CyberArk Digital Vault machine. 15. Press Next to accept the default Program Folder. 16. The Performing Vault Server Machine Hardening window will appear. This may take a fewminutes. Page 22 Note: Enter the password ‘Cyberark1’ as the default password. It is recommended to set a stronger password in a production environment. 17. Set Built-in Users Passwords - Set passwords for the Master and Administrator; enter Cyberark1 in all the password fields and press Next. Note: In the SkyTap environment, you may receive a message that the hardening process failed. If so, press the Retry button. In training, a failure is usually caused by a timeout in stopping services because we are using virtual machines with limited resources. Page 23 18. Choose “No, I will restart my computer later” and press Finish. Page 24 Note: If the message “Windows SmartScreen can’t be reached right now” appears, click “Run PrivateArk Client Installation Next, we will install the PrivateArk Client on the Vault server. 1. In File Explorer go to “C:\\CYBR_Files\\Vault Installation Files\\Client”. Right click setup.exe and choose “Run as administrator”. 2. Accept the default options in each of the next six windows. In the User Information dialogue,enter your name and company or simply “Windows User” and “CyberArk” Page 25 3. Press OK to define your first connection to the PrivateArk Vault. This will create a shortcut toyour Vault within the PrivateArk Client. 4. Enter the following information: Server Name Vault Server Address 10.0.10.1 Default User Name Leave Blank or enter Administrator (blankmeans the client will remember the last logged on username) Page 26 5. Press OK. 6. Press OK to acknowledge the proxy server message. 7. Select Yes, I want to restart my computer now and press Finish. Page 27 Note: The CyberArk Enterprise Password Vault is now installed. Post Vault Installation 1. Login to the Vault01A server and double-click the “PrivateArk Server” shortcut on the desktop to open the Server Central Administration utility. Confirm there are no errors, and “ITADB313I Server 12.1.0 (12.1.0.9) is up” informational message appears. 2. Launch the PrivateArk Client from the desktop. Double click the Vault shortcut and login as Administrator/Cyberark1. a. Ensure that the 3 default safes exist, System, VaultInternal and Notification Engine. If any of these 3 safes do not exist stop and inform the instructor. b. Logoff and close the PrivateArk Client. 3. Open Windows Services and check that the following services have been installed and started. a. Cyber-Ark Event Notification Engine 1 b. Cyber-Ark Hardened Windows Firewall c. CyberArk Logic Container d. PrivateArk Database e. PrivateArk Remote Control Agent f. PrivateArk Server Page 28 Objective: Install the PVWA on both component servers, Comp01A and Comp01B. More information is available online at docs.cyberark.com. See “PVWA Installation Overview” Password Vault Web Access software will be installed manually however, Prerequisites and Hardening procedures will be configured using PowerShell Automation scripts. Note: CyberArk provides a script to automate PVWA prerequisites. These scripts install the Web Server role and features, creates a self-signed web certificate and configures the Note: Ensure that all Virtual Machines (VM’s) are started in your Skytap lab before Get-ExecutionPolicy (Result should be “Restricted”) Set-ExecutionPolicy Bypass -Scope Process .\\PVWA_Prerequisites.ps1 Install Password Vault Web Access Install IIS Pre-requisite Software using Automatic prerequisites script 1. Sign in to ‘Comp01A’ VM as ACME domain user with local admin privileges, i.e.,VaultAdmin01@acme.corp. 2. Open File Explorer and navigate to the shared resource folder, “Z:\\CyberArk PAMSolution\\v12.1\\”. If Z: is not mapped, map a drive to “\\\\dc01\\shared”. a. Copy “Password Vault Web Access-Rls-v12.1.zip” and “Client-Rls-v12.1.zip” files to “C:\\CYBR_Files”. If the destination folder does not exist, create it. Do not copy any other files. b. Extract the zip archives to the default folder. 3. Navigate to “C:\\CYBR_Files\\Password Vault Web Access-Rls-v12.1\\InstallationAutomation”. 4. Open Windows PowerShell as an Administrator in the folder specified in step 3 and execute the following PowerShell commands. Select Yes when prompted. Page 29 Note: The PVWA_Prerequisties script creates a self-signed certificate and uses this certificate for binding HTTPs incoming requests. In a production environment, we recommend to update the HTTPS binding with a certificate provided by a Trusted Certification Authority. Note: Online instructions for the deployment of PVWA pre-requisites please refer to PVWA Installation Overview Objective: In the following procedure you will replace the self-signed certificate created by the Prerequisites script with a Web Certificate provisioned by the ACME Certificate Authority. Certificates have been provided for both PVWA Servers; Comp01a and Comp01b. 5. Verify the script completed successfully by reviewing the Script.log found in the “C:\\CYBR_Files\\Password Vault Web Access-Rls-v12.1\\Installation Automation\\{date_time}” 6. Open the IIS Manager console and verify that IIS was installed, that a self-signed certificate was generated and that incoming HTTPs requests are using the certificate. a. Navigate to the “Default Web Site”, select Edit Site, Bindings. Edit the HTTPS Binding and confirm the self-signed SSL certificate is assigned. Import Trusted Certificates for WebHosting 1. Sign in to PVWA Server Comp01a as Administrator. 2. Launch Internet Information Services (IIS) Manager from the Start Menu > Administrative Tools. Under Connections, select the Host name then double click “Server Certificates”, as shown in thegraphic. Page 30 3. Select “Import…” from the Actions menu and then the ellipsis to search for the Certificate file (.pfx). 4. Navigate to C:\\CYBR_Files and select the COMP01A_SSLWEB.pfx file and click Open. Enter the password “Cyberark1”, select Certificate Store: Web Hosting. Select “Allow this certificate to beexported”. 5. Under Connections, expand Sites and select Default Web Site. In the Actions column, select Bindings… 6. Double click the https binding. Select the imported certificate “COMP01A_SSLWEB”. 7. Click OK and Close. Page 31 Objective: In this section we will configure IIS to require connections over SSL. Note: This is also a prerequisite for later authentication sections. Objective: Install the Password Vault Web Access component on Comp01A. Note: It is recommended to gracefully restart each component server prior to running the Installation Automation PowerShell scripts. Require HTTP over SSL (PVWA) 1. Begin by launching IIS Manager (INETMGR) from the Start Menu > Administrative Tools on your Component server. 2. Go to Default Web Site and double click SSL Settings (golden padlock). Select Require SSL andclick Apply in the Actions menu. 3. Validate the IIS installation. This is an important step to confirm that the IIS server is functioning correctly prior to the PVWA software installation. Open Internet Explorer and attempt to connect to the default web site on the component server with http and https URL’s. What is the expected behavior of each? a. “https://comp01A.acme.corp/” b. “http://comp01A.acme.corp/” Install PVWA 1. Using File Explorer, navigate to folder “C:\\CYBR_Files\\Password Vault Web Access-Rls-v12.1\\”. 2. Right click setup.exe and “run as Administrator”. Page 32 3. If prompted, select to install the Microsoft Visual C++ 2013 Redistributable Packages. 4. Press the Next button, then click Yes to agree to the license agreement. 5. Enter a Company name, press Next. 6. Press Next to accept the default Configuration files destination and Web application destination. Page 33 7. Press Next to accept both Setup Type options. 8. On the Web application details window… a. Select CyberArk and LDAP as the Authentication Type. b. Choose None in Default Authentication and Default Mobile Authentication fields and press Next to continue. 9. On the Vault Server and PVWA connection details window… a. Enter the Vault IP address (e.g. 10.0.10.1) b. We will be load balancing PVWA servers in this lab thus we need to update the PVWA URL:field with the URL to the load balancer. Enter the URL as follows; “https://pvwa.acme.corp/PasswordVault” and press Next. Page 34 10. Enter UserName = Administrator and Password = Cyberark1 and select Next. On the InstallShieldWizard Complete window, click the Finish button. 11. Post PVWA installation: a. Check the PVWAInstall.log in directory C:\\Users\\Administrator\\AppData\\Local\\Temp\\. b. Open Chrome and connect to the PVWA. Use URL https://comp01a.acme.corp/PasswordVault/v10/logon and confirm that the PVWA login pageis displayed. This step validates that the PasswordVault application is communicating with the PrivateArk Server. c. Sign in to the PVWA using CyberArk Authentication as Administrator. Validate tabs Policies,Accounts, Applications, Reports and Administration display correctly. d. Logout of the PVWA. Page 35 Note: Most of the PVWA hardening procedures can be accomplished with a PowerShell script although each procedure can be performed manually. See PVWA Installation Overview for a checklist when installing the PVWA in a production environment. Note: Not all configurations can be scripted. Some hardening procedures require manual steps. The following procedure instructs the student how to harden the Network Interface manually, then proceeds using the Installation Automation PowerShell scripts. More information can be found online at “PVWA Hardening”. Objective: A PVWA or CPM server only requires Client for Microsoft Networks, File and Printer Sharing for Microsoft Networks and the TCP/IPv4 network protocol. We will disable all Hardening the CyberArk PVWA Server Hardening the PVWA server ensures that your PVWA server meets CyberArk’s security standards in 'InDomain' deployments as well as in 'Out of Domain' deployments. CyberArk Component Server hardening is a combination of enforcing security policy (via GPO or INF), manual tasks plus automated procedures using Installation Automation PowerShell scripts. Manual Hardening 1. Right click on the Start Menu, select Network Connections > Change adapter options. Page 36 2. Right click on the Public Network Adapter and choose Properties. 3. Only the following network protocols, services or clients are required for a CPM and or PVWAComponent Server: a. Client for Microsoft Network b. File and Printer Sharing for Microsoft Network c. Internet Protocol Version 4 (TCP/IPv4) d. Disable all other default protocols, services and clients as shown in the graphic. e. Restart the server. Page 37 Get-ExecutionPolicy (Result should be “Restricted”) Set-ExecutionPolicy Bypass -Scope Process .\\PVWA_Hardening.ps1 Note: “Get-ExecutionPolicy” will display the current Execution Policy “ExecutionPolicy Restricted” is the default Execution Policy for ACME.Corp “ExecutionPolicy Bypass -Scope Process” sets the Execution Policy to Bypass for the current PowerShell session but does not change the default execution policy for PowerShell “.\\PVWA_Hardening.ps1” will launch the PowerShell hardening script Installation Automation Hardening 1. Sign in to the Comp01A server as local Administrator or ACME Domain user with Local Adminprivileges, i.e., VaultAdmin01. Navigate to “C:\\CYBR_Files\\Password Vault Web Access-Rls- v12.1\\InstallationAutomation\\” 2. Open Windows PowerShell as an Administrator in the folder specified in step 1 and execute the following PowerShell commands. Select Yes when prompted. 3. Review the Script.log that was created in “C:\\CYBR_Files\\Password Vault Web Access- Rls-v12.1\\InstallationAutomation\\timestamp” Page 38 Objective: Remove unneeded Application Pools. Objective: In this section, you will repeat the steps for installing the PrivateArk Client on the Comp01A server. Final Manual Hardening Configuration for PVWA Deployments IIS Hardening 1. Application Pool. Open IIS Configuration Manager. 2. In Connections, navigate to Application Pools. Keep the following application pools only. Delete allother existing Application Pools: a. DefaultAppPool (Managed Pipeline Mode = Integrated) b. PasswordVaultWebAccess (Managed Pipeline Mode = Integrated) Install the PrivateArk Client on the Component server 1. Using File Explorer navigate to “C:\\CYBR_Files\\Client-Rls-v12.1\\Client”. Right click on setup.exeand run as Administrator. 2. When prompted, enter the Server Name and Server Address as shown. 3. Restart when prompted. Page 39 Note: CyberArk provides a Group Policy Object specifically for dedicated PVWA Component Servers and a separate GPO for PVWA/CPM co-hosted Component Servers. In this lab the CyberArk Component Servers Comp01A and Comp01B will co-host both the PVWA and CPM components. The Group Policy Object has already been imported to the Group Policy Management Console for the ACME.CORP domain. For additional instructions on importing the GPO to an Active Directory domain, follow this link, Hardening PVWA servers in a domain Objective: Enable the PVWA Hardening GPO for the PVWA/CPM Servers in Active Directory Group Policy Management. Note: The CPM-PVWA Hardening GPO has been edited to allow the local service account PasswordManagerUser the “Logon as a service” right. Automated Hardening: Group Policy Enforcement PVWA GPO hardening enhances PVWA security by defining a highly secured Windows server. Enabling and enforcing the PVWA Group Policy Object is included as part of the PVWA installation andhardening procedure and is not optional. 1. Sign in to the DC01 Virtual Machine as Administrator/Cyberark1. 2. On the Desktop, double click the Group Policy Management Console. 3. Expand acme.corp > Servers > CyberArk and select the CPM-PVWA Organizational Unit. 4. Right click the CPM-PVWA Organizational Unit and select “Link an Existing GPO…” 5. Select “CPM-PVWA Hardening” GPO and click OK. Page 40 Objective: In this section you will install and perform hardening tasks on the CPM server. More information is available online at docs.cyberark.com. See “CPM Installation Overview” Note: Ensure that all Virtual Machines(VM’s) are started in your Skytap lab before proceeding (with the exception of the DR VM). Get-ExecutionPolicy (Result should be “Restricted”) Set-ExecutionPolicy Bypass -Scope Process .\\CPM_Preinstallation.ps1 Install CPM Install CPM 1. Sign in to your first CPM server, Comp01B as administrator. 2. Open File Explorer and navigate to the shared resource folder, “Z:\\CyberArk PAMSolution\\v12.1\\”. If Z: is not mapped, map a drive to “\\\\dc01\\shared”. 3. Copy “Central Policy Manager-Rls-v12.1.zip” to “C:\\CYBR_Files”. Extract the zip archives on theComponent Server. Do not copy any other files. 4. Using File Explorer, navigate to “C:\\CYBR_Files\\Central Policy Manager- Rls-v12.1\\InstallationAutomation”. 5. Open Windows PowerShell as an Administrator in the folder specified in step 4 and execute the following PowerShell commands. Confirm by entering the character ‘Y’. 6. Verify the script completed successfully by reviewing the Script.log found in the “C:\\CYBR_Files\\Central Policy Manager-Rls-v12.1\\Installation Automation\\{date_time} 7. In File Explorer open the extracted \\Central Policy Manager folder. Right click setup.exe and choose “Run as Administrator”. 8. If applicable, select Install to install the required Windows redistributable package. 9. Accept the default options on the next four windows, including your company name (e.g. CyberArk) on the Customer Information page. Page 41 Note: This question relates to installing CPM software using an existing licensed CPM user or installing an additional CPM that will consume a new license. 10. Accept the default option, “No Policy Manager was previously installed” and press Next. Page 42 11. In the following 2 prompts, enter the IP Address of your Vault (i.e., 10.0.10.1) and enter Administrator as the Username and Cyberark1 for the Password. Then press Next. 12. You may receive the following error; “CPMEM038E Error while trying to import platforms…”. Thisis common in the Skytap environment. Please ignore and select Next to continue. 13. Press the Finish button to complete the installation. 14. Immediately following the CPM installation, review the CPMInstall.log file created in “C:\\Users\\Administrator\\AppData\\Local\\Temp\\”. To access this directory, in the File Explorer address window, type %appdata%, then in the address bar, change from Roaming to Local and navigate to the \\Temp directory. This file contains a list of all the activities performed when the CPM environment in the Vault is created during the installation procedure. Page 43 Objective: Hardening the CPM server ensures that your CPM server meets CyberArk’s security standards for 'In Domain' deployments as well as in 'Out of Domain' deployments. CPM server hardening is automated via a combination of an applied Group Policy for in- domain deployments and PowerShell scripts. Both are necessary. CPM and PVWA GPO’s have been applied during the PVWA hardening phase earlier in this lab. Get-ExecutionPolicy (Result should be “Restricted”) Set-ExecutionPolicy Bypass -Scope Process .\\CPM_Hardening.ps1 Post CPM Installation Review the following. 1. Navigate to “C:\\Program Files (x86)\\CyberArk\\Password Manager\\Logs”. Check the pm.log and pm_error.log file for errors. 2. Confirm that the CPM services are installed and running. a. CyberArk Password Manager Service. b. CyberArk Central Policy Manager Scanner. Harden the CPM server(s) 1. Sign in to Comp01A/B as local Administrator and navigate to “C:\\CYBR_Files\\Central PolicyManager-Rls-v12.1\\InstallationAutomation”. 2. Open Windows PowerShell as an Administrator in the folder specified in step 1 and execute the following PowerShell commands. Confirm by entering the character ‘Y’ when prompted. 3. Wait until the script completes. “isSucceeded”: 0” represents confirmation of the successful completion of the hardening script. Page 44 Note: If the services are not started, the CPM hardening script may not have been successful in granting the local PasswordManagerUser, the “logon as a service” right. In this Skytap lab; a Group Policy is enforcing this right for the PasswordManagerUser however in a production deployment the GPO may not yet be applied, or the setting may not be defined correctly. The “logon as a service” right can be confirmed in the Script.log file, created by the hardening script, located in the InstallationAutomation folder. Search Script.log for the key word “SeServiceLogonRight” a. Logs detailing the actions taken by the PS script can be found in a subfolder of “…\\InstallationAutomation\\{date-time}”. 4. Open the Windows Administrative Tools > Computer Management. a. Select Services and Applications > Services. Check the status of “CyberArk PasswordManager” and “CyberArk Central Policy Manager Scanner” Windows services. b. Confirm that the services are running under the credentials of the local user “PasswordManagerUser”. Page 45 Note: The CPMHardening.ps1 script attempts to add the above exceptions automatically. If the exceptions are not created, this is a clue that the CPM_Hardening.ps1 script was not run in an “Administrators: PowerShell Window”. If hardening manually this step is required to support terminal based CPM plugins. 5. Confirm that plink.exe, pmterminal.exe and telnet.exe are defined as exceptions to Data Execution Prevention. a. At the Start Menu, Run command, type “sysdm.cpl”. Navigate to Advanced > Performance > Settings > Data Execution Prevention. Page 46 Note: Ensure that all Virtual Machines(VM’s) are started in your Skytap lab before proceeding with the exception of the DR VM. Objective: Install and configure 1 Standalone PSM Server. Install PSM The Customer has purchased CyberArk’s Privileged Session Management (PSM) in order to monitorand record and activity related to privileged accounts in the network: PSM 1 server Comp01c (10.0.22.1) Page 47 Note: To learn more about the actions performed by the CyberArk PowerShell scripts described in this section, please refer to docs.cyberark.com Objective: Execute PowerShell scripts to install IIS on Windows. It is recommended to perform a graceful restart of the component server prior to installation to clear any pending Note: The installation folder for PSM must not be in a deep directory structure. Shorten the directory path of the extracted folders as follows. Install a Standalone PSM Server The PSM installation is divided into several configurable stages: setup (prerequisites), installation, post installation, Hardening and registration. PSM Installation Prerequisites 1. Sign in to the Comp01C server as Admin02@acme.corp/PW=Cyberark1. 2. Open File Explorer and navigate to the shared resource folder, Z:\\. If the drive is not mapped, map a network drive to Z: at \\\\dc01\\shared. a. Navigate to “Z:\\CyberArk PAM Solution\\v12.1”. Copy the following zip files to “C:\\CYBR_Files”. • “Privileged Session Manager-Rls-v12.1.zip” • “Client-Rls-v12.1.zip” Page 48 Get-ExecutionPolicy (Result should be “Restricted”) Set-ExecutionPolicy Bypass -Scope Process b. Extract all files from “Privileged Session Manager-Rls-v12.1.zip” to the destination folder“C:\\PSM” as shown below. 3. In File Explorer, navigate to “C:\\PSM\\InstallationAutomation\\Prerequisites”. 4. Edit PrerequisitesConfig.xml using “Notepad ++” search for and set all Enable= steps to YES. Savethe file and exit. 5. Open Windows PowerShell as Administrator. Change directories to “C:\\PSM\\InstallationAutomation”. 6. Execute the following commands. Page 49 .\\Execute-Stage.ps1 “C:\\PSM\\InstallationAutomation\\Prerequisites\\prerequisitesConfig.xml” Note: Customer requirements are a PSM ‘In Domain’ installation to enable RemoteApp program features, thus the PSM installation prerequisites must be completed while signed in as a domain user with local Administrator rights. 7. Then launch the Execute-Stage.ps1 script with the location of the PrerequisitesConfig.xml as the argument. Example: 8. Several scripts will be executed during this process. 9. When prompted in PowerShell, restart the server. 10. After the server restarts, sign in with the same credentials used in step 1, admin02@acme.corp/Cyberark1. 11. The PowerShell script will launch immediately to complete the prerequisite installation. Allow the script to complete, then exit PowerShell. Page 50 12. Review the PSMPrerequisites<date><time>.log file located in C:\\Windows\\Temp directory. 13. A final step before PSM Installation is to assign an appropriate Domain Group access to the Session Collection. Open Server Manager and navigate to Remote Desktop Services -> Collections - > PSM RemoteApp > Properties > TASKS > Edit Properties -> User Groups. a. Add ACME\\CyberArk Vault Admins and remove ACME\\Domain Users, as shown. Page 51 Note: To enable RemoteApp program features, PSM installation must be completed while signed-in as a domain user with local Administrator rights. Install the PSM signed-in as Admin02@acme.corp PSM Installation 1. Sign-in to the Comp01C server as Admin02@acme.corp/PW=Cyberark1 2. Using File Explorer, navigate to “C:\\PSM”. Right click setup.exe and choose “Run asadministrator”. 3. Select to install the Microsoft Visual C++ Redistributable Packages. 4. Click Next on the welcome screen, then Yes to agree to the license agreement 5. Enter a company name, click Next, then leave the default destination folder and click Next. Page 52 6. Accept the default Recordings Folder and click Next, then accept the default Configuration safes name and click Next. 7. Enter the IP Address of the vault (i.e., 10.0.10.1) and click Next, then enter the username Administrator, password Cyberark1 and click Next. 8. At API Gateway connection details option, select Next and Yes to confirm. We will not beconfiguring the API Gateway in this lab. Page 53 9. Do not select the “Enable PKI authentication for PSM” option and select Next. 10. Ensure “Harden the PSM server machine” checkbox is selected and click the Advanced option. Page 54 11. At the Hardening step, open File Explorer and navigate to C:\\Program Files(x86)\\CyberArk\\PSM\\Hardening. a. Use Notepad++ to edit file PSMConfigureApplocker.xml. b. Search for SIHOST.EXE. Replace Method=Publisher with Method=Hash” c. Search for Chrome.exe and remove the comments < ----- > d. Return to CyberArk Privileged Session Manager Setup. 12. Select all options EXCEPT “Configure Out of Domain PSM Server” and click Next. 13. At InstallShield Wizard Complete windows, select “No, I will restart my computer later” and click Finish. 14. Install the PrivateArk Client and choose to restart the server when complete. a. Use the Vault IP address 10.0.10.1, for both Server Name, and Address fields, when defining the first Vault. 15. Following the installation and server restart, go to C:\\Windows\\Temp and review the PSM related log files; PSMHardening, PSMInstall, PSMPostInstallation log files. Page 55 Note: The Following errors are possible in the Skytap environment. Error: Failed to disable First Run Wizard error in PSMPostInstallation.log. The script is attempting to update a parameter that has been set during by the PSM installer. Error: Failed to block IEDevTools in AfterHardening phase is expected. The script may fail to block Internet Explorer Dev Tools. Google Chrome is the default browser and IE will not be used for PSM connection components. If IE is used at a customer site, this parameter must be set manually. You can confirm the above setting is enabled by opening the Local Group Policy Editor GPEDIT.MSC. Navigate to Computer Configuration > Administrative Templates > Windows Components > Internet Explorer > Prevent running First Run wizard. Should be enabled, and using REGEDIT at HKLM:\\SOFTWARE\\Policies\\Microsoft\\Internet Explorer\\IEDevTools, REG_DWORD “Disabled” = 1. Page 56 The following procedure will guide you through the steps to assign a certificate to the Remote Desktop Services deployment in support of the PSM Farm virtual hostname. A certificate has been provided by the Certificate Administrator for both PSM Servers; Comp01c and Comp01d. Note: You must be signed in to one of the component servers, i.e., Comp01A/B with a domain account for PSM Connection Components to be successful. If signed into the server as the local Administrator, the current user will not have access to the Certificate Update RDS Certificate 1. Sign in to PSM Server Comp01c as Admin02. 2. Open Server Manager and select Remote Desktop Services in the left navigation pane. 3. In Deployment Overview select Tasks > Edit Deployment Properties. In the Configure the deployment window, select Certificates > Select existing certificate… > Choose a differentcertificate and browse to C:\\CYBR_Files. 4. Select the file with the .pfx extension and click Open. In the Password: field enter Cyberark1, select the box to “Allow the certificate to be added to the Trusted Root Certification Authorities…” and select OK to close the Deployment Properties window. Attempt to connect to different target devices using the PSM-Farm virtual PSM server and observe there are no certificate errors using the psm-farm.acme.corp host name defined in the psm-farm server connection details. Page 57 Objective: To configure the vault to use LDAP over SSL connections, you must import the Certificate Authority’s root Certificate into the Windows Trusted Root Certificate Store on the Vault Server. The following procedure will guide you through transferring the certificate file from the component server, to the vault server where it can be imported. Note: Ensure that all Virtual Machines(VM’s) are started in your Skytap lab before proceeding (with the exception of the DR VM). Integrations LDAP Authentication (over SSL) Install the CA ROOT Certificate on the Digital Vault 1. Sign in as Local Administrator on server Comp01A server. Open a ChromeBrowser. 2. From the Favorites Bar, select “CAU LAB Links” > “ACME Certificate Services” or browse tohttps://dc01.acme.corp/certsrv. a. If prompted, log into the web page as Administrator/Cyberark1. 3. Click on Download a CA certificate, certificate chain, or CRL. Page 58 4. If prompted, click Yes to allow this operation. 5. Click Download CA certificate. 6. Select Keep to store the certificate in the Downloads folder. 7. Log into PrivateArk Client as Administrator. You may need to add a new shortcut to the Vault server. 8. Open and Enter the VaultInternal safe. 9. Click the Store menu option, or right click in the body of the safe, and select Store, Move File to Safe. a. Navigate to the Downloads folder and select the file just downloaded, certnew.cer. Page 59 10. Logoff from PrivateArk Client on the Components Server. 11. Sign into the Vault01a server as Administrator. 12. Login to PrivateArk Client as Administrator. 13. Open and Step into the VaultInternal safe. 14. Right click certnew.cer and click Retrieve and Save As… 15. Save the file to the Desktop and logoff PrivateArk Client. 16. Right click on the Start Menu and select Run. Type CERTLM.MSC and click OK. Page 60 10.0.0.2 dc01.acme.corp 17. Expand Certificates (Local Computer) > Trusted Root Certification Authorities > Certificates. 18. From the Action menu, select All Tasks > Import ...; the Certificates Import Wizard appears. 19. Click Next to display the File to Import window. Browse to select the certificate file saved to the Desktop. Click Next to display the Completing the Certificate Import Wizard window appears. 20. Select Place all certificates in the following store, Certificate store: “Trusted Root Certification Authorities” then click Next to display the Completing the Certificate Import Wizard window. 21. Review the settings and select Finish. Update the HOSTS file to Enable Host Name Resolution 1. In File Explorer, navigate to directory, “C:\\Windows\\System32\\drivers\\etc” 2. Select the File menu > Open command prompt as administrator. Select Yes at the User Account Control popup window. 3. At the Administrator: Command Prompt, type “Notepad hosts” and press enter. 4. Add the following line to the end of the file and save it. 5. Sign out of the Vault Server and sign in to either the Comp01A or Comp01B Server as LocalAdministrator. 6. Using the Chrome Browser, sign in to the PVWA as Administrator using CyberArkauthentication and display the User Provisioning > LDAP Integration page. 7. Select New Domain to display the LDAP Integration Wizard. Page 61 8. Proceed through the LDAP Integration Wizard using the following parameters. Domain Name: acme.corp Connect via: Secure connection (SSL) Address: dc01.acme.corp Bind user name: bindaccount@acme.corp Bind user Password: Cyberark1 Domain Base Context: dc=acme,dc=corp As you can see, there are four AD groups and each group is mapped to a CyberArkrole as shown in the table below. CyberArk Role LDAP Group Vault Admins CyberArk Vault Admins Safe Managers CyberArk Safe Managers Auditors CyberArk Auditors Users CyberArk Users Page 62 Note: In the above example we can see that users who belong to the AD group CyberArkVault Admins are mapped to this role, and that the authentication method they will Click on the Vault admins mapping to expand it. In the Details tab you can see the mapping criteria, the mapping destination in theVault, the authentication method the mapped users will use to authenticate to CyberArk, and how many days user activity logs are kept. Page 63 To know what Vault authorizations are assigned to the mapped users, click on the Vault authorizations tab. Here we can see that users who are mapped to the role of Vault admins will be assigned with all Vault authorizations, except for Backup all safes and Restore all safes. In other words, members of the AD group CyberArk Vault Admins will be assigned these Vault authorizations when they authenticate to CyberArk for the first time. When you are ready, click on the Edit button. Page 64 Note: In a production implementation it is recommended to configure 2 Domain Controllers at the company’s primary site, and 2 additional Domain Controllers at Do not select ‘Next’ until all 4 directory maps have been defined. Note: 10. Note you can now edit all the settings we reviewed in the Details page as well as editthe Vault authorizations that are assigned to users who meet the search criteria. 11. Select the domain controller listed; dc01.acme.corp and select Connect. 12. In Create directory mapping option, click Define map to the right of each user group name and specify the name of the user or group. • Select the appropriate group for each field. • When complete, click Next. Define Vault Admin Group: CyberArk Vault Admins Define Safe Managers Group: CyberArk Safe Managers Define Auditors Group: CyberArk Auditors Define Users Group: CyberArk Users Page 65 13. Review the summary and select Save. 14. Test your LDAP/S integration by signing in to the PVWA as vaultadmin01/Cyberark1 using LDAP Authentication. 15. Navigate to Policies and change policy rule “Require privileged session monitoring and isolation” to Active. Page 66 User Management Know the Players Before we begin, let's first get to know the different users we will be using throughout thislab and their roles. The password for all these users is Cyberark1. Page 67 Create LDAP Users 1. Login DC01 server with Administrator (Cyberark1) 2. Open Active Directory Users and Computers. 3. Navigate acme.corp > Domain Users and Groups > IT > Users >New > User Page 68 4. Type First name and User logon name as Mike, Then click Next Page 69 5. Create password as Cyberark1 and mark check box for User can’t change password and Password never expires, Then Click Next and Finish as shows Figure. 6. Same as Mike Create other LDAP users as listed below a. Carlos b. Cindy c. John d. Paul e. Robert f. Tom Page 70 Create IT Mangers Group 1. Navigate acme.corp > Domain Users and Groups > IT > Groups >New > Group 2. Create Group Name ITManagers ,Then select Group scope Global and Group type Security. Page 71 Create Service Accounts 1. Navigate acme.corp > Domain Users and Groups > Service Accounts > Right Click > New > User. 2. Create new user CYBR Reconcile as shown and click Next Figure. 3. Create password Cyberark1 and click check box for Password never expires. Click Next and Finish. 4. Same as above create CYBR Scan User with Password Cyberark1 Page 72 Adding Users to LDAP Groups or AD Groups:- 1. Find Mike user Under Users and right click > Properties. 2. Under properties > Member of tab Click Add… tab Page 73 3. Type CyberArk Vault Admins then Click Check names and OK. Repeat again for Domain Admins . 4. Same as above Do for all users with respect to Default Groups. a. Carlos i. CyberArk Users ii. LinuxAdmins b. Cindy i. CyberArk Auditors c. John i. CyberArk Users ii. WindowsAdmins d. Paul i. CyberArk Safe Managers ii. ITManagers e. Robert i. CyberArk Safe Managers f. Tom ii. CyberArk Safe Managers i. ITManagers 5. Navigate acme.corp > Domain Users and Groups > Cyberark > Service Accounts. Same as above add those CYBR Reconcile and CYBR Scan accounts to Domain Administrators Group Page 74 Create Accounts for Discovery and Onboarding 1. Login as Administrator in Comp01C with Cyberark1. 2. Open Computer Management 3. Navigate System tools > Local Users and Groups > Users > right Click > New User 4. Create User name Localadmin01 and password Cyberark1, Mark check box Password never expires, and Click Next 5. Add the LocalAdmin01 user to the Administrators group. Page 75 Objective: Create several accounts to validate and test the basic features and functionality of the installed components. Sign in to the PVWA using VaultAdmin01. Note: Ensure that all Virtual Machines(VM’s) are started in your Skytap lab before proceeding (with the exception of the DR VM). 6. Same as Above create localadmin02 to localadmin06 with same password Cyberark1 7. Also create discovery01 to discovery05 with same password Cyberark1. EPV Testing and Validation Page 76 Note: As earlier when you logged in as Administrator, you will arrive by default in the Accounts View. Notice, however, that you do not see the same accounts. Eachuser will only see the accounts that are in Safes to which he or she has been Securing Windows Domain Accounts In this section, we will look at how to secure Windows domain accounts. We will begin with accounts that are owned by the CyberArk Vault Administrators and that are used byCyberArk PAM to perform CPM operations: • A reconciliation account – cybrreconcile • A discovery account – cybrscan We will duplicate a Platform for these accounts, create relevant exceptions to the MasterPolicy, create a Safe, add an Active Directory group as members of the Safe, and then add the accounts to the Safe. Platform Management Duplicating a Platform If you are not still logged in, connect to the PVWA using LDAP authentication with theVault Administrator account mike with the password Cyberark1. As shown in the image below, in the Toolbar along the left side of the page, click onthe down icon of the Administration menu to expand, then click on Platform Management. Page 77 Expand the Windows section to view the platforms there. Select the Windows Domain Accounts platform and press the Duplicate button. Enter as the name WIN DOM ADM 15 (you can also give it a meaningful description)and then press Create. Page 78 Note: While not required, it is always a good idea to press the Apply button to make sure your changes are saved (bottom right of the screen). Configure Password Management 6. Select the WIN DOM ADM 15 platform and press the Edit button. 7. Click on UI & Workflows and change AutoVerifyOnAdd from No to Yes. Page 79 Note: This setting will prompt the CPM to automatically verify the password whenever a new account assigned to this platform is added. Note: Changing the ImmediateInterval to 1 is only suitable for testing and should be left to its default value. CyberArk-Service-Accounts|Wind- Warning! Do NOT copy and paste from the PDF file. It will probably not work. Make sure there is no space in front of or behind the | symbol. Note: This regular expression restricts the Safes to which this Platform can be applied to only those Safes that start with the string “Win-Dom-” or the safe named “CyberArk- Service-Accounts”. This field is case sensitive. 8. Go to Automatic Password Management -> General and change the value of ImmediateInterval to 1. 8. Still in Automatic Password Management -> General, enter the following into the AllowedSafes parameter. Page 80 Note: The sum of the various complexity parameters must be less than or equal to PasswordLength for password change to function. However, the system does not check the values for you. Note: Notice that some of the Platforms are Active while others are Inactive. It is best practice in CyberArk PAM to deactivate all Platforms that are not being actively used. Now that we have created our own Platform for Windows domain accounts, Press Apply. Go to Password Change and set PerformPeriodicChange to Yes. Go to Password Verification and set VFPerformPeriodicVerification to Yes. Finally, go to Generate Password. Here, we are going to modify the passwordlength and complexity to give us more secure passwords for our domain admin accounts. Set the values as follows: PasswordLength 17 MinUpperCase 2 MinLowerCase 2 MinDigit 1 MinSpecial 1 Press Apply and OK to save all your changes and close the Platform. To deactivate a platform, select the platform, click on the ellipsis, and select Page 81 Deactivate. Editing the Master Policy In this section, you will modify the Master Policy to: • Change passwords for all accounts every 60 days • Create an exception for the Platform WIN DOM ADM 15 to rotate passwords every15 days Password Change Policy To edit the Master Policy, click on Policies in the left-hand toolbar. By default, youwill land in the Master Policy. In the Password Management section, select Require password change every X days and then in the Rule Preview area on theright, click on the pencil icon to edit the default value of 90 days. Change the value to 60 and then click the diskette icon to save your change. Page 82 Add Exceptions Let’s also add an exception for the Platform we created earlier – WIN DOM ADM 15 – sothat its passwords are changed every 15 days, rather than every 60 days. Again, select the option Require password change every X days and click Add Exception. Select the Platform WIN DOM ADM 15 and click Next. Page 84 Change the value from 60 to 15 and click Finish. You should now see an exception to the Master Policy. Page 8 Safe Management In this section, we will create a Safe to store several accounts that are used by the Vault Administrators to manage other privileged accounts in CyberArk PAM. Specifically, we will store our reconcile account and our accounts discovery scan account. Creating a Safe In the left-hand toolbar, click on POLICIES -> Safes, Now click Create Safe. Enter CyberArk-Service-Accounts as the Safe name. You can provide a meaningful description. Leave the other values at their defaults and press Save. 5 Note: This Safe name must match exactly the name we put into the AllowedSafes parameter for the platform we created a moment ago, which is case sensitive. Page 86 Add Safe Members On the Safe Details page, click the Add Member button to grant other users accessto this safe. Enter “cyberark v” (without the quotes) in the Search field, leave Vault as the value inthe Search In field, and click Search. Page 87 Select the group CyberArk Vault Admins, check all the boxes to give Vault Administrators full rights on these CyberArk service accounts, and click the Addbutton. Click Close when you are done. Page 88 You will now see the group CyberArk Vault Admins listed in the Members. Now add another CyberArk group to the Safe: CyberArk Safe Managers. In the Access section, remove the permissions for Use accounts and Retrieve accounts,leaving them only the List Accounts permission, as shown in the image below. Wewill need this for a later exercise. Account Management In this section, we are going to add two accounts from Active Directory to CyberArk PAS beginning with our reconcile account. Add the reconcile account Page 89 Please note that the account is named cybrreconcile (that is cybr, without the “e”). Go to the ACCOUNTS tab and press the Add Account button. First select the System Type. Click on Windows Next, select the Platform we created for domain accounts: WIN DOM ADM 15. Page 90 Select the Safe we created: CyberArk-Service-Accounts. Enter the following and then press Add: Address : acme.corp User name : Cybrreconcile Password (Optional) : Cyberark1 Conform Password : Cyberark1 Log On To : < click on Resolve > Page 91 Note: Because AutoVerifyOnAdd was set to Yes, the account will be scheduled for immediate verification. In a minute or two, you should see that the account was verified by PasswordManager. Select the newly created account from the list and then click on the link Additionaldetails & actions in classic interface to open the account in the classic interface. Copy the Safe name and the Name values to Notepad (we’ll be using these values ina later Page 92 Best Practice: After adding a new account, you should rotate the password so that only CyberArk PAM knows the password. Go ahead and change the passwords forboth cybrreconcile and cybrscan. exercise). They should look something like this: Add the accounts discovery account We will need another Windows account for a later exercise – cybrscan. Add a secondWindows domain account using the information below. Again, please note that it is CYBR (without the E). Store in Safe: CyberArk-Service-Accounts System Type: Windows Platform Name: WIN DOM ADM 15 Address: acme.corp User Name: cybrscan Password: Cyberark1 Confirm Password: Cyberark1 Page 93 Securing Unix SSH Accounts In this section, we will be managing a “Unix SSH” account or, to be more precise, a Linuxvia SSH account. In the previous section, we were managing what we could call “meta-accounts”: accountsthat are owned by the Vault Administrators and that are used by CyberArk PAM to manage other accounts (which we will see later). Here, we are dealing with a typical account. It is an account that is owned by an IT team (in this case the Active Directory group LinuxAdmins) and as such our Vault Administratorsdo not need to know the password or have access to it. To achieve this, we are going to divide the tasks of configuring CyberArk PAM to managethese accounts into separate phases and perform the actions by “changing hats”; that is, logging into CyberArk PAM with different user accounts according to the table below: Role Action User Vault Administrator Configuring Platforms and setting Policies. Mike Safe Manager Creating Safes, adding members, adding accounts. Paul Auditor Verifying that accounts are being used according to corporate policy. Cindy Vault Administrator Tasks – Mike Vault administrator tasks are handled by Mike, so use this account to login to the PVWA. Duplicating a Unix Platform Here you will create a Platform to manage Linux accounts that connect to their targetswith SSH. Navigate to ADMINISTRATION -> Platform Management, expand the section *NIXthen UNIX via SSH, click on the three points at the end of the line and select Duplicate. Page 94 Important! Although you are free (and encouraged) to apply your own naming conventions for Platforms and Safes in your own environments, please note that we will be referringto the names provided here in later exercises. If you choose to give your Platforms and Safes with different names, it may prevent you from completing later exercises successfully. We therefore recommend you use the names suggested in the guide. Enter LIN SSH 30 in the Name field and optionally something like Linux servers viaSSH, rotate passwords every 30 days for a description and then press Create. Highlight the newly created platform and press Edit. Page 95 Note: Changing the ImmediateInterval field to 1 is only suitable for testing and should set to 5 or higher in a real environment. Go Automatic Password Management -> General. Change ImmediateInterval to 1 Change AllowedSafes to Lin- (case sensitive). This determines which safes can usethis platform. Click Apply to save your changes, but do not exit the platform just yet. Note: Until recently, the default password length for *nix accounts in CyberArk PAM was 8. It has been increased to 12. Note: As we have duplicated the Unix via SSH platform to a new platform, you can now deactivate the Unix via SSH platform. Note: Some features may require the use of the UI´s classic interface (pre-version 10). To access this, you may need to select Additional details & actions in classicinterface, as shown below. Page 96 Now go to Password Change and change the value of the parameter PerformPeriodicChange from No to Yes. This will enable the application of the Master Policy rule Require password change every X days to accounts managed bythis platform. Within the same window, go to Password Verification and change VFPerformPeriodicVerification from No to Yes. This will allow the password to beverified by the CPM automatically and without user intervention. Finally, in Generate Password, note that the default password length for Unix machines is 12 characters. This value can be changed to reflect your organization’srequirements. Click Apply and OK. Configuring the Master Policy Add an Exception for the New Platform We have already seen how to create a Master Policy exception. Create a new one for ournew Platform that rotates the passwords every 30 days. Safe Manager Tasks – Paul For this section, we will need to “change hats”; that is, we need to imagine that we are a different user. We are no longer a Vault Administrator, but a Linux system administrator named Paul. We have been instructed to place all our privileged accounts into CyberArkPAM so that their passwords (and SSH keys) will be stored in the Vault. Paul is a member of the Active Directory groups CyberArk Safe Managers. This means that when he logs in to CyberArk PAM, he will have the right to create Safes, add users tothe Safes he creates, and to add new accounts to those Safes, which is what we shall do. Page 97 We will perform the basic tasks required to manage a privileged account on a Linux serverto which we connect using SSH. We will create a Safe to securely store the account and add an AD group of users who are authorized to use the account. We will then add the new account, verify that we can connect with it, and see how an auditor can monitor the account activity. Creating a Safe Log in to the PVWA as Paul with the password Cyberark1 using LDAP authentication. Notice that Paul can see the CyberArk service accounts, but he isunable to view the passwords or use the accounts due to his permissions. Go to POLICIES -> Safes and click Create Safe. Enter Lin-Fin-US as the Safe Name. This is the Safe where the ACME Corporationwill store the privileged accounts for its Linux servers that hold financial data for its US division. You can also provide a meaningful description. We won’t worry aboutthe other parameters for now, so press Save when you are done. Page 98 Add Safe Members Press Add Member to grant other users access to the new Safe. Enter linuxad in the Search field, select acme.corp in the Search In field and press Search. Select LinuxAdmins, uncheck the option Retrieve accounts, and press Add. Page 99 Now add another group. This time add the LDAP group CyberArk Vault Admins with the permissions only List under Access and all permissions under Account Management. Note: You should now see that the LinuxAdmins group has been added to the newly created Lin- Fin-US safe. We removed the ‘Retrieve’ option so that users will neverhave access to the password. They can use it to connect, but never actually see it.Also note that the user logged in is the creator of the Safe and is granted full We also added the CyberArk Vault Admins group so that they will be able to perform account onboarding, which we will see later, but they will not be able to view the passwords or even use the accounts to connect. CyberArk Privileged Access Management 12.2 – Administration Click Add and then close the Add Safe Member window. Adding a Linux account We have created a Platform and a Safe. Now we will add our first Linux account and storeit in the Lin- Fin-US safe and manage it with the LIN SSH 30 platform. 1. Go to ACCOUNTS and click Add Account. On the Add Account page, first select the system type *NIX and click Next: CyberArk University Exercise Guide page 100 3/15/2022 © Cyber-Ark® Software Ltd - No part of this material may be disclosed to any person or firm or reproduced by any means, electronic and mechanical, without the express prior written permission of Cyber-Ark® Software Ltd. page 101 Select the LIN SSH 30 platform and click Next: Select the Safe we created earlier: Lin-Fin-US and click Next. page 102 Note: In the image above, only one safe appears. Why is that? Enter the account details as shown below and click on Add: Address: 10.0.0.20 Username: logon01 Password: Cyberark1 Confirm Password: Cyberark1 page 103 On the Accounts page, select the newly created account. In Account Details, press the Change button to confirm that you have created the account correctly andto change the password to a value known only to CyberArk PAM. You will be asked to confirm the password change. Click Change. You will see a brief message at the top of the screen: After a minute or two, you will see that the value for Compliance Status is updatedto Changed by PasswordManager. page 104 Note: The behavior of RDP files will depend on the browser you use. The example shown here is from Google Chrome. Test the New Account as Safe Manager Paul wants to make sure that his new account is working correctly, so we are going toconnect to the target system using the account through the PSM. Click on the account logon01 and click the Connect button. Click on the RDP file to open it. You may receive a pop-up warning about thepublisher of the RemoteApp program. Click Connect to continue. The first time you connect to a particular machine, you will receive an alert about theserver’s host key. Click Yes to accept the server’s key. page 105 In the lower right-hand corner of the screen, you will see a pop-up informing you thatthe session is being recorded. It will disappear automatically. And then a PuTTY window will appear in your taskbar with your SSH connection tothe machine target-lin as logon01, click on it to display. Close the RemoteApp window by typing “exit” (without the quotes) and hitting Enter.In the PVWA, you can view some of the messages your actions generated in the Activities list. page 106 Log out of the PVWA. Test the New Account as a Normal End User Our first test verified that we can establish a connection to the target system using the PSM. Now we want to just make sure that a normal user – i.e., a user who must use CyberArk PAM to get his or her job done – can use the account to connect to the target. There is an AD user named Carlos who is a member of the AD group LinuxAdmins, whichyou will remember is the group Paul added as a member of the Safe Lin-Fin-US. Log in to the PVWA as Carlos with the password Cyberark1. page 107 Note: Notice that the Show and Copy buttons are greyed out. This is because Paul removed the Retrieve option for these users. They can connect to the target system, but they will never know what the password is, making it less likely that the Click on the logon01 account and then click the Connect button. As you did in the previous test, open the RDP file, accept the publisher and the server key. Execute a few simple, non-destructive commands (remember, you are aprivileged user) such as pwdand ls -alto generate some session activity. 4. When you are done, enter exitand hit Enter to close the session. page 108 Auditor Tasks In this step you will review the activity related to the logon01 account by putting on ourauditor’s hat. Sign out of the PVWA and log in using LDAP Authentication as cindy. In the left-hand toolbar, click on the Monitoring tab. Click on Carlos in the list of Recordings. page 109 Notice that you have the details of what happened during the session under Activities, including the commands you executed. Click on the Play button to viewthe recording. The recording plays automatically. You can pause, rewind, fast-forward, or jump to aspecific place in the recording by clicking on a command. page 110 You can close the recording window by clicking on the X in the upper right-handcorner. Sign out of the PVWA. Securing Oracle Database Accounts In this section, we will configure CyberArk to manage an Oracle DBA account. As in previous exercises, we will duplicate a Platform, create a Safe, and then add the account. Vault Administrator Tasks Duplicating a Platform In this section, we are going to create a Platform dedicated to managing accounts used toaccess Oracle databases, such as a DBA account. Log in to the PVWA as mike and go to ADMINISTRATION -> Platform Management. Choose Database -> Oracle Database and select Duplicate. Enter ORA DBA 30 and press Create. page 111 Note: Now that we have duplicated the Oracle Database platform, you can deactivate the base Oracle Database platform. Note: Don’t forget to add an exception to the Master Policy to rotate the oracle DBA passwords every 30 days. Select ORA DBA 30 and select Edit. Go to UI & Workflows and set AutoChangeOnAdd to Yes. Go to Automatic Password Management -> General. • Set ImmediateInterval to 1 • Set AllowedSafes to Ora- Now go to Automatic Password Management -> Password Change and change the value of the parameter PerformPeriodicChange from No to Yes. This will enablethe application of the Master Policy rule Require password change every X days to accounts managed by this platform. Within the same window, go to Password Verification and change VFPerformPeriodicVerification from No to Yes. This will allow the password to beverified by the CPM automatically and without user intervention Press Apply. In the Generate Password section, add the equal sign character (‘=’ without the quotes) to the PasswordForbiddenChars field. Make sure you add the new characterwithout deleting any of the existing characters. Click OK to save the changes and close the Platform. page 112 Safe Manager Tasks Because we are dealing with a different technology – Oracle in this case – the person responsible for managing Oracle Safes is different. Our Safe Manager for this exercise isnamed Robert. Creating a Safe Log in to the PVWA as LDAP user Robert and go to POLICIES -> Safes. Press the Create Safe button. Enter Ora-Fin-US as the Safe name and press Save. Add the Active Directory group OracleAdmins to the Safe, removing the Retrieve permission (make sure to search for the group in acme.corp). Now add the LDAP group CyberArk Vault Admins. Remove the permissions: Use accounts and Retrieve accounts. Add Account Management (which will add all thepermissions under it). We will need this for a later exercise. page 113 Note: Because the policy was set to AutoChangeOnAdd=Yes, the account will be set for immediate change. Adding an Account Go the ACCOUNTS tab, click Add Account and enter the following: System type Database Platform ORA DBA 30 Safe Ora-Fin-US User Name dba01 Address 10.0.0.20 Password Cyberark1 Confirm Password Cyberark1 Port 1521 Database xe Press Add. page 114 Note: In the Unix/Linux world, the account that is typically prevented from connecting to a server remotely is the root account. Here in CyberArk training, we are going to use an account named user01 and we will use the account we created earlier, logon01, as the logon account. Press refresh and you will see the message: ‘The password for this account hasbeen manually scheduled for change’. Once the password has been changed by the CPM, press the Show button to displaythe new password. Linked Accounts Securing SSH Accounts Using a Logon account In this exercise you will add to your CyberArk PAM implementation a Linux privileged account that is prevented by the target machine’s security policy from accessing the servervia SSH, which is a very common restriction for root accounts. You will then associate a logon account with this new account, allowing you to use and manage the password despite the SSH restriction. The logon account establishes the connection to the target machine and executes a switch-user operation to the privileged account. Log into the PVWA as Paul (this is a Safe Manager task). Go to the Accounts page and press the Add Account button. On the Add Account screen, enter the following: System Type: *NIX Platform Name: LIN SSH 30 Store in Safe: Lin-Fin-US Address: 10.0.0.20 Username: user01 Password: Cyberark1 Confirm Password: Cyberark1 Press Add. page 115 On the Account Details page, press the Verify button. The status will appear as‘This account is scheduled for immediate verification’. Eventually this will fail because the CPM received an ‘Access Denied’ message due to therestriction on user01 (in the log file you should see an error message – “Permission Denied”) Click on the account User01, then Details, and click on […] in Logon Account in the Linked Accounts section. page 116 Search for the account logon01 and click OK Go back to Overview, press the Verify button and click OK to confirm. If you receivethe following message, press OK. page 117 Securing Windows Server Local Accounts via a Reconcile Account In this exercise you will add a Windows local server account for which the correct password is unknown. To bring this account under management, you will associate it witha domain administrator account (cybrreconcile) that can perform a password reset. Vault Administrator Tasks Duplicating a Platform Log in to the PVWA as mike. Go to ADMINISTRATION -> Platform Management. Select the Windows Server Local Accounts and click Duplicate. Note: After a few minutes, the account should be verified. In the background the CPM connected to the server as logon01 and switched to the user01 account to verify the page 118 Note: Once again, we are modifying this value for training purposes only, enabling us to move a little faster. A one-minute immediate interval is suitable for testing butshould be Enter WIN SRV LCL ADM 45 as the platform name, you may optionally add a description like “Rotate password every 45 days”, and press Create. Highlight the newly created platform and select Edit. Go to UI & Workflows. Change AutoChangeOnAdd from No to Yes. This causes the CPM to initiate a password change whenever a new account that uses this policy is created. SelectApply to save your change. Go to Automatic Password Management -> General and set the ImmediateInterval to 1. Enter Win-Srv- in the AllowedSafes field to limit the accounts with which this platformcan be used. Click Apply to save your change. Now go to Automatic Password Management -> Password Change and change the value of the parameter PerformPeriodicChange from No to Yes. This will enablethe application of the Master Policy rule Require password change every X days to accounts managed by this platform. Within the same window, go to Password Verification and change VFPerformPeriodicVerification from No to Yes. This will allow the password to beverified by the CPM automatically and without user intervention. page 119 Note: The values for the parameters as they appear above assume that you have followedall previous instructions to the letter. If you haven’t, then these values will not work.Also, copying and pasting from the PDF into the virtual machine causes problems, so the safest approach is to do as instructed earlier and copy the values from the PVWA, paste them into Notepad, and then copy them into the appropriate fields in Go to Password Reconcilation and enter following: RCAutomaticReconcileWhenUnsynced: Yes ReconcileAccountSafe: CyberArk-Service-Accounts ReconcileAccountName: (you can copy this from the notepad file that you created earlier, do NOT copy from this PDF) page 120 Press Apply and OK to close the platform. Log out of the PVWA session. Safe Manager Tasks Once again, we are changing hats and are going to log in as a Safe Manager named Tom,who is responsible for the Windows servers team. In this part of the exercise, we will: • Create a Safe • Add Members to the Safe • Add an Account Creating a Safe Now we are going to create a Safe for our Windows server local administrator accounts. To comply with data protection regulation, we are going to organize our Safes so that onlyUS admins can access the passwords for US safes. Log in to the PVWA as the AD user Tom with the password Cyberark1. Go to POLICIES -> Safes and click Create Safe. Name the Safe Win-Srv-Fin-US. Leave the default values for the rest. Add the AD group WindowsAdmins to the Safe, but remove the check for Retrieve Accounts – we don’t want our local administrators to view passwords. As this is the first time, we are assigning permissions to this group, make sure to search for the group in acme.corp. Note: Think about what appropriate values for password length and complexity would be. Don’t forget to add the relevant exception to the Master Policy to enable automatic password rotation every 45 days. As we have now duplicated the Windows Server Local Accounts, you can deactivate the platform. page 121 Now add the LDAP group CyberArk Vault Admins. Remove the permissions: Use accounts and Retrieve accounts. Add Account Management (which will add all thepermissions under it). We will need this for a later exercise. page 122 Note: After adding the account, you should see a message stating ‘The password for thisaccount has been manually scheduled for change. This is because you set AutoChangeOnAdd to Yes in the policy. Also note that there is a reconcile account Adding Oracle Account Here we will add a local administrator account for your target Windows server: target- win.acme.corp. Remember, we don’t know what the password is, so you could put anything in the password fields (although they must match). We are still using the Tomaccount. Go to the ACCOUNTS page, and press Add Account. Enter the following and pressthe Add button: System type Windows Platform WIN SRV LCL ADM 45 Safe Win-Srv-Fin-US Address 10.0.22.1 User Name localadmin01 Password <leave blank> Confirm Password <leave blank> Logon To (optional) <click to resolve> page 123 Note: Before next exercise Open Chrome browser from Comp01A server, Open below link and download all 3 files to the desktop 1. Putty gen.exe 2. Libra Ofice 3. Passwords.csv Install Putty gen.exe and Libra Office on Comp01A for further Process. Press Refresh. Because the password for this account is incorrect, the passwordchange will fail. Press Refresh again and after a short time and you should receive a message saying that the account was successfully reconciled. The first time an account isreconciled it can take a little while, so be patient. page 124 Securing UNIX Accounts with SSH Keys In this section, we will perform the tasks required to manage a Linux account that connectsto its target server with a public-private key-pair. Before this Download Putty Key Gen from Drive, use this below link Generating a Key-Pair On the Components server launch PuTTY Key Generator from the Taskbar Click Generate in the PuttyGen window: As instructed, you need to make mouse movements in the blank area to generate random data for the key. page 125 When the key is generated, click Save Private Key. Click Yes to store they key without a passphrase. The CPM does not support privatekeys with passphrases. page 126 Name the key root01.ppk and save it to your Documents directory. Select all the text in the ‘Public key for pasting into Open SSH authorized keys file’box and copy it to your clipboard. page 127 Use PuTTY to connect to Target Linux. Select Target Linux, click the Load button, then click Open to launch the pre- configured connection. When prompted, log in as root01 with the password Cyberark1. Note: You might want to paste the public key into a text file for safe keeping, because if you close Putty, you will lose it and need to regenerate a new key-pair. page 128 vi ~/.ssh/authorized_keys Warning! It can be a bit tricky to copy and paste into a terminal window. Make sure that yourkey text begins with the string “ssh-rsa” and that it ends with “rsa-key-date” where date is today’s date. :wq Edit your authorized key file with vi. Press i (or the Insert button on your keyboard) to enter insert mode. Right-click inside the editor to paste the key. Verify that the key pasted correctly. Press ESC and then enter: That is : (colon) (w) (q) and then press ENTER to save and exit. page 129 cat ~/.ssh/authorized_keys Note: If you need help with the vi editor, you can read the tutorial at: http://www.tutorialspoint.com/unix/unix-vi-editor.htm Make sure the key appears in the authorized_keys file (and that all characters werepasted properly) by using the cat command: Exit your PuTTY session. Verify you can login with the Private Key Now we will test that we are able to authenticate with the private key. Open PuTTY again. Select the Target Linux connection and add a new name, suchas Target Linux Key root01 and click Save. This will save the new configuration in case you need to come back again. Navigate to Connection -> Data and enter root01 in the Auto-login username field. page 130 Navigate to Connection -> SSH -> Auth, click Browse, and select the ppk file youcreated earlier. Go back to the main window and save your configuration again with the new values. Now click Open and verify that you can log on without supplying a username and page 131 Note: It should be noted that adding an SSH key does not automatically disable password authentication for this account on the target. You will still be able to log in with the password for root01. password. Type exit and then hit Enter to close the session. Duplicating a Platform – Vault Administrator Task Login to PVWA as mike and go to ADMINISTRATION -> Platform Management. Highlight *NIX -> Unix via SSH Keys (make sure that you choose the Unix via SSHKeys platform, not the “Unix via SSH” platform). Select Duplicate. Name your platform LIN KEYS 90 and click Create. Select LIN KEYS 90 and select Edit. Go to Automatic Password Management -> General. • Set ImmediateInterval to 1. • Set AllowedSafes to Lin-. Press Apply. Now go to Automatic Password Management -> Password Change and change the value of the parameter PerformPeriodicChange from No to Yes. This will enablethe application of the page 132 Note: Now that we have duplicated the Unix via SSH Keys platform, you can deactivate the base Unix via SSH Keys platform. Note: Don’t forget to add an exception to the Master Policy to rotate SSH Keys every 90 days. Master Policy rule Require password change every X days to accounts managed by this platform. Within the same window, go to Password Verification and change VFPerformPeriodicVerification from No to Yes. This will allow the password to beverified by the CPM automatically and without user intervention. Add an Account with an SSH key – Safe Manager Task Log in to the PVWA as Paul. Go to the ACCOUNTS VIEW page and click the Add Account button. Add an account with the following properties. If you do not see the SSH Keyconfiguration area, you may have duplicated the wrong platform. System Type: *NIX Platform Name: LIN KEYS 90 Safe Name: Lin-Fin-US Address: 10.0.0.20 Username root01 Private Key: Browse to find the root01.ppk file you created earlier. You may also paste the content of the private key. page 133 Click Add. You will receive a notification that the account has been added: Click Change to rotate the key pair. Click OK. This process can take a few minutes. Once the change completes, verify that you are NOT able to connect with PuTTY using the private SSH key stored locally on the Components server. As a final step, you can test connecting to the target system using the newly createdaccount in the PVWA. page 134 Privileged Access Workflows In this section, we will configure the Master Policy for three Privileged Access Workflows: • Reason for access • Dual control • Exclusive passwords Require users to specify reason for access In this section we will test the Require users to specify reason for access workflow as wellas configure predefined reasons. Activating the Policy Log into the PVWA as mike and go to POLICIES -> Master Policy -> Privileged Access Workflows, select Require users to specify reason for access, and pressAdd Exception. Select LIN SSH 30 and press Next. page 135 Set Require users to specify reason for access to Active. Set Allow users to specifyreason for access to Inactive. Click on Finish. Add Predefined Reasons for Access Navigate to the ADMINISTRATION tab and click Platform Management. Select the LIN SSH 30 and click on Edit. Right-click on UI & Workflows and select Add Privileged Account Request. Expand Privileged Account Request and then right-click on Predefined Reasons.Select Add Reason to add predefined reasons. Add the following predefined reasons (you may also add your own if you wish). page 136 When you finish, click on OK to save and exit. Testing Predefined Reasons for Access Now, log into the PVWA as Carlos and select the user01 account. Click on Connect. Select one of the predefined reasons, for example, Emergency Reboot. Then click on Connect again to download the RDP file. Click on the RDP file to connect to the target machine. Once the connection to the target machine has been established, navigate to the Activities tab and verify you can see the Audit details for the Connect action. page 137 When you are finished, disconnect from the target machine. Require dual control access approval Dual control – requiring a manager to validate a request for access approval for certainaccounts – is a 2-step process: 1. You must activate the policy Require dual control password access approval, either globally or by exception for a certain Platform (which is the usual case and what wewill do). 2. Add an approver to a Safe, either a group or a user, with at least the List Accounts and Authorize account requests permissions. This minimum configuration would give the manager/approver the right to validate the requests, but not the right to use the passwords to connect to target systems (they onlyhave List, not Use or Retrieve). Activating the Policy Log into the PVWA as mike and go to POLICIES -> Master Policy -> PrivilegedAccess Workflows, select Require dual control password access approval, and press Add Exception. page 138 Select LIN SSH 30 and press Next. Click Active. Review (but do not modify) the other options available. When ready,press Finish. page 139 Adding an approver to a Safe The workflow process is configured through Safe membership. We need to add a manager to a Safe containing accounts that are managed by the Platform for which we have created our exception so that he/she can approve requests. In our example, members of the group ITManagers will be able to approve requests, but they will not ableto Retrieve the passwords or Use them. Log on to the PVWA as Paul and go to POLICIES -> Safes. Highlight Lin-Fin-US and press the Members button. Click Add Member. Enter ITManagers in the Search field, select acme.corp in the Search In field, andpress Search. Select the ITManagers group. Under Access, remove the checks for Use accounts and Retrieve accounts for thisgroup. page 140 Scroll down and expand the Workflow link to access the Authorize account requestscheck box. Check the Authorize account requests authorization box with Level 1 remove the Access Safe without confirmation permissions. Press Add. Testing Dual Control Testing this workflow requires us to wear a number of hats. We configured the system asa Safe Manager – Paul – now we are going to become ordinary users of the system. • We will first log in as a user who has the right to use a password, but only with manager approval – Carlos. • We will then put on our manager hat and check our email, notice that we have a notification for an approval request pending, log into the PVWA as that manager user – Tom – using the link provided, and approve the request. • Finally, we will return to the PVWA as Carlos, find the approval notification, and access the target system with the password. First, login to the PVWA as the LDAP user Tom with the password Cyberark1 (note Tom can now see Linux accounts as well as Windows, but he is unable to use the Linux accounts, only approve Dual Control requests by members of the Linux team). Note: Because we will be changing users, you might want to use two browsers or separate browser sessions. You can use incognito mode to open two separate sessions withtwo separate users. page 141 Next, open a different browser or incognito mode in Chrome, and login in as theLDAP user Carlos with the password Cyberark1. Locate the logon01 account and select the Request Connection button. Select a Reason to access the account. Note that you are unable to enter free textand can only see the pre-defined reasons we configured in the previous exercise. Activate the Timeframe and specify FROM the current date in the morning TO theend of the last day of the class. Also activate Multiple access is required and then press on the Send Request button. Launch a new browser session and open the email client (there is a short-cut in thebrowser toolbar). page 142 Note: Unfortunately, because we are using Mike to login to the Windows OS, we will notbe able to click on the link in order to navigate directly to the Incoming requests page. Instead, we will login to the PVWA and navigate manually. Login as Tom. You should have received an e-mail with the new request (if you donot receive an email, make sure the ENE service is running on the Vault). Login to the PVWA as Tom (password Cyberark1) if you are not already logged in. Go to Accounts and select Incoming Requests. Locate the incoming request from Carlos and press the Confirm button. page 143 Enter a reason and press Confirm. Before signing out, go to the Accounts View. Take note of the fact Tom is unable tomake requests to view the logon01 password or use it to connect. Sign out and close the browser to terminate the Tom session. Browse to the email client and login as Carlos. You should receive an e-mail statingthe request has been confirmed. Login to the PVWA as Carlos (password Cyberark1) if you are not already logged on,then go to the Account View page. Notice the Status of the request is now confirmed. You can now use the password and connect to the previously requested account. Sign out of the Carlos session. Exclusive Passwords with Automated Release and One-time Use In this exercise, you will configure the Windows Server Local accounts added earlier forexclusive access with an automatic release based on the Minimum Validity Period. page 144 Adding a Master Policy exception for Exclusive Passwords Exclusive Passwords are configured in the Master Policy. login to the PVWA as mike. Go to POLICIES -> Master Policy and select Enforce check-in/check-out exclusiveaccess and click Add Exception. Select WIN SRV LCL ADM 45 and press Next. page 145 Note: This next step is for testing/training purposes only and should not be used in a production environment. Press the Active button to enable Enforce check-in/check-out exclusive access andclick Finish. Adding a Master Policy exception for One-Time Passwords To allow for an automatic release of a checked-out password, you will need to enable thepolicy Enforce one-time password access for the platform WIN SRV LCL ADM 45. Highlight Enforce one-time password access and press Add Exception. Select WIN SRV LCL ADM 45 and press Next. Press Active to enable one-time password access for this platform and then click Finish. Reducing the Minimum Validity Period We will set the Minimum Validity Period to 5 minutes, so that we can see our results morequickly. The MinValidityPeriod parameter is configured in the Platform. Go to ADMINISTRATION -> Platform Management, select WIN SRV LCL ADM 45,and click Edit. page 146 Go to Automatic Password Managment -> Privileged Account Management. Set MinValidityPeriod to 5. Press Apply and OK to close the Platform and then sign out of the PVWA. Right-click the restart-services.bat on the desktop of your components server and select Run as administrator. This will cause the CPM server to reload all policies andforce your configuration changes to to take affect immediately. Testing Exclusive Passwords In this section, we will test our configuration of exclusive passwords with automatic release. We will use the users Tom and John. Tom is the Safe Manager (therefore itsowner) and John is a member of the Active Directory group WindowsAdmins. Login to the PVWA as the LDAP user Tom with the password Cyberark1. Go to ACCOUNTS. Click on the localadmin01 account and click the Show button. Tom has nowchecked out the password. page 147 Note: Only Tom or a user who has the \"Unlock Account\" permissions on that Safe can release the account manually by using the “Check-in” option, however we will notuse this option as we want to see the system release it automatically at the end of the Minimum Validity Period. You should be able to see the password as well as disclaimer stating the password isavailable for the next 5 minutes, after which it will be rotated. Log out of the PVWA and log back in as John. You should notice a lock icon next tothe localadmin01 account. Hover over the lock icon, it should say “The account is checked-out by Tom”. If you press Connect, you will be able to download the RDP file. However, if you clickon the RDP file and attempt to launch a connection, you will receive an error message. 8. After several minutes (remember the minimum validity period was set to 5 min), John willbe able to access the password and the CPM will have changed the password. page 148 Testing Automatic release by PSM Starting with v11.7, the PSM can also release an account locked by exclusive access uponclosing the remote session. Perform the following steps to test automatic release by the PSM: Login to the PVWA as mike and navigate to ADMINISTRATION -> Platform Management. select WIN SRV LCL ADM 45 and click Edit. Navigate to Privileged Session Management and set ExclusiveUnlockAfterPSMSession to Yes. Right-click the restart-services.bat on the desktop of your components server and select Run as administrator. This will cause the PSM server to reload all policies andforce your configuration changes to to take affect immediately. Login to the PVWA as John and locate the localadmin01 account. Click on Connect. After the session to the target machine has been established, confirm the account islocked by John. Now, disconnect from the target machine. Hint: If the account is not released after several minutes, run the restart-services.bat file and check again. page 149 If everything has been configured correctly in the previous steps, the localadmin01 should be unlocked immediately by the PSM (without password rotation). To confirm,open the Account details page and look at Activities. You should be able to see that the account has been unlocked by the PSM. page 150 Then, after a few minutes, the account password will also be rotated by the CPM (thanks to the One-time password setting). page 151 Discovery and Onboarding In the following exercises you will use the Accounts Feed feature to discover and onboardaccounts to the system. Accounts Feed In this section you will configure rules for automatically onboarding accounts discovered using the Accounts Feed feature, run a Windows Discovery to discover and automatically onboard accounts, and lastly you will manually onboard accounts that were not covered bythe automatic onboarding rule. Configure Automatic Onboarding Rules In this section, you will configure Onboarding Rules to add newly discovered accounts tothe Vault without any human intervention. Login to the PVWA as mike. Go to Accounts -> Accounts Feed -> Onboarding Rules. Click on Create rule. page 152 In Select system type, select Windows. In Select Scope select the following: Machine Type: Server Account Type: Local Account Category: Any Privileged Account Type: Any Username (begins…): discovery page 153 Click Next. In Assign to platform select WIN SRV LCL ADM 45. In Store in Safe select Win-Srv-Fin-US. page 154 Note: The user cybrscan is an Active Directory account created especially for the purposes of running Accounts Discovery scans. It is a member of the Domain Admins AD group. In Define rule properties enter the following name: Discovery users and click Next. Review your rule and if everything seems to be in order, click on Create rule. Configure and Run Windows Accounts Discovery The Accounts Discovery process requires an account to log in to the domain and scan theindividual machines. We will use the cybrscan account we created in the first exercise. page 155 Go to Accounts -> Accounts Feed -> Pending & Discovery -> Discovery Management and click New Windows Discovery. Enter acme.corp in the Domain field and then use the Click to select an accountfrom the Vault link. Select the account cybrscan that we created in an earlier exercise and click the Select account button. page 156 Back in the main dialog, you will see a summary of the account selected. Now scrolldown to the next section. In the What to scan? section, click Browse. page 157 Select the Servers container and press OK. Under What recurring pattern to set for this Discovery? Select Onetime, thenclick Done. page 158 You will receive a message saying that the Windows discovery has been added.Press OK. Press the Refresh icon to update the status. You may need to back out of the window and go back in to see the state change. This can take a few minutes. Youshould see the status change from Pending to Running. After several minutes, the process should appear as Completed. page 159 Note: The discovery will complete with errors. This is expected in our environment. Go to Accounts -> Accounts View. If you configured your automatic rules properly,you should be able to see all the “discoveryXX” accounts in the accounts view (thereare 10). You should have assigned a reconcile account to the platform, so the accounts added should also be reconciled or scheduled for immediate reconciliation. page 160 Note: The account localadmin02 has a scheduled task dependency (schedtask02) associated with it. By onboarding the account, we will also onboard the scheduled Manually onboard discovered accounts In this section, we will manually onboard an account that was discovered but for whichthere was no automatic onboarding rule. Go to the Pending Accounts list, enter localadmin02 in the Keywords field, and runa search. Select the resulting localadmin02 account. Click on the 1 under Dependencies tosee the dependency associated with the account. page 161 Press the Onboard Accounts button. In the Onboard Accounts window, select the following: Store in Safe Win-Srv-Fin-US Assign platform WIN SRV LCL ADM 45 Password Automatically reconcile password (this will only be available if the assigned platform contains a reconcile account) Note: One of the main benefits of discovery and onboarding is the ability to discover dependencies tied to Windows accounts. Unlike the previous exercise, this time the dependency will be onboarded along with the target account, and the CPM will manage the dependency without any human intervention. page 162 Press Onboard. You should receive a message saying “Successfully onboarded 1account(s) and related dependencies. Press Done. Go to the ACCOUNTS page and search (press the magnifying glass icon top right) for the newly created account. Because the platform was configured for automatic reconciliation, you should see that the account has been reconciled. Confirm that you can also see there is a dependency associated with the account. page 163 schtasks /run /s target-win /tn SchedTask02 To confirm the scheduled task is also working, open a command line interface andinput the following command. Now, login to the email client as Mike and verify that you received the email confirming schedtask02 is working. Add Multiple Accounts from File Frequently there is a need to upload many known accounts into CyberArk PAM from anexisting repository. This is especially valuable during the early stages of implementing CyberArk PAM, migrating from another solution, or when onboarding a newdepartment into the PAM solution. In this section you will: • Upload an accounts file • View the status of the upload process • Download a detailed result file with the failed accounts and error messages page 164 Open the File explorer on your Components server and go to Desktop. Open the Passwords.csv file. Make sure to select Comma in Separator Options. Review the file and the properties of the accounts we are about to upload to the CyberArk PAM solution. page 165 Now, login to the PVWA as mike. Go to ACCOUNTS -> Accounts View and select Add accounts from file. First, review the instructions in the page. Note you can also download a sample CSVfile. When you are ready, click on Drag and drop file or browse. Navigate to c:\\Add-Accounts and select the accounts-Linux.csv file. Review the page and click Upload. You should see a notification on your screen reporting the success of the action. Refresh the page. Search for logon and confirm the accounts were onboarded. page 166 You may also select some of the accounts and launch a Verify or Change action toconfirm the CPM is able to manage the target accounts. page 167 Hint: PSM Secure Connect is at the bottom of the list. Connect using PSM Ad-Hoc Connection Next, you will configure a PSM Ad-Hoc Connection (previously known as Secure Connect), which allows you to launch a PSM connection using unmanaged accounts. First, log into the PVWA as mike, and go to ADMINISTRATION -> Platform Management. Select PSM Secure Connect and activate it. Go to POLICIES -> Master Policy. In the Session Management section, select Require privileged session monitoring and press Add Exception. Select PSM Secure Connect and press Next. Select Active and press Finish. Now go to the ACCOUNTS page and click on Ad-Hoc connection. Enter the following: Platform PSMSecureConnect Client: WinSCP Address: 10.0.0.20 User Name: root01 Password: Cyberark1 Map Local Drives: Checked (scroll down) Port 22 Press Connect. page 168 page 169 Privileged Session Management In this section, we are going to look at some of the audit information that was gathered by CyberArk PAM during our PSM testing. We will also be monitoring live sessions and test session termination and suspension. To do so, we will need to connect as a user who is a member of the Auditors group – Cindy. PSM Session Terminators As mentioned, we will be testing live monitoring, as well as session suspension and session termination. While all members of the Auditors group can monitor live sessions, not all members of the Auditors group have permissions to terminate or suspend sessions.Only users who are also members of the built-in PSMLiveSessionTerminators group have permissions to do so. For your convenience, Cindy, the ACME corporation auditor, has been pre-added to this group. Monitor, Suspend, and Terminate Active Sessions Login to the PVWA as John and open a privileged session using the localadmin01 account via the PSM. Logout of the PVWA (or use incognito mode) and login in via LDAP as Cindy. Go to the MONITORING pane. page 170 Note: Not all members of the Auditors group can terminate, suspend, or resume sessions.These permissions are only available to users who are also members of the internal PSMSessionTerminators group. Go to Active Sessions and locate the session opened by John and click on Monitor.You should now be able to monitor John’s session as it happens. As Cindy, try to Monitor, Suspend, Resume, and ultimately Terminate the session. page 171 Monitor Recordings As Cindy, verify that you can see the recordings related to your prior sessions and tryto play some of these recordings. Note that recordings related to PSM for SSH are presented in the classic UI. You can also search recordings by activities in a privileged session. For example, enter salary in the Session activities field and press Apply. Once you locate the SQL recording, click on Play. Review the recording. Click on the session line for more detail and find the command“select * from scott.salary”. Note that the recording will now start at the command selected. Close the playback window when you are done. page 172 page 173 Cd C:\\Remote Control Client C:\\Remote Control Client>PARClient.exe 10.0.10.1/Cyberark1 Cyber-Ark Remote Administration Client (12.2.70.0) Working with agent on: 10.0.10.1 Loaded component from [C:\\Remote Control Client\\PARClusterVaultClient.dll] Loaded component from [C:\\Remoteexit Control Client\\PARDRClient.dll] Loaded component from [C:\\Remote Control Client\\PARENEClient.dll] Loaded component from [C:\\ Remote Control Client\\PARVaultClient.dll] PARCLIENT> Note: The connection string is made up of the executable, the Vault address (here its IP address), and the password for the Remote Control Client that was set during installation. This password cannot be managed by the Vault and so must be managed manually. PARCLIENT> status vault Vault is running. Note: Depending on how long after logging in you wait to run the command, you may be PARCLIENT> stop vault Are you sure you want to stop the remote Vault (Y/N)? y Password:********* Remote Control Client We are now going to execute a few simple commands using the Remote Control Client, a command-line tool for performing remote administration on the Vault. 1. Login Comp01D with Local Administrator Password Cyberark1 2. On the Comp01A or Comp01B server, Open File Explorer and navigate to the shared resource folder, “Z:\\CyberArk PAM Solution\\v12.1\\”. If Z: is not mapped, map a drive to “\\\\dc01\\shared”. 3. Copy “Remote Control Client-Rls-v12.1.zip” to “C:\\ Remote Control Client”. Extract the zip archives on the Component Server. Do not copy any other files. 4. Open a command-line window (either the classic Windows command line or PowerShell – there are short-cuts in the Task bar) andchange directory to: To start the Remote Control Client, run the following command (highlighted in yellow below): Once you have the PARCLIENT prompt, get the current Vault status by running: To stop the Vault, run the following: page 174 PARCLIENT> start vault Password:********* Vault was started, pending service running. use status command for further details. PARCLIENT> start ene Password:********* ENE was started, pending service running. use status command for further details PARCLIENT> status ene ENE is running. PARCLIENT> status vault Vault is running. To restart the Vault, run the following: When you stop the Vault, the Event Notification Engine, or ENE, is also stopped because it is dependent on the Vault service. However, when you start the Vault, the ENE is not automatically restarted. You must restart it manually by running: As a final step, check the status on these two Vault services by running: Type exit and hit enter to exit the PrivateArk Remote Control Client. page 175 Unsuspend a suspended user In this exercise, you will provoke a user suspension by entering the incorrect password fora user and then see how an administrator or a help desk user can unsuspend the user. From the Comp01A server, try to login via the PVWA as Vaultadmin01 using a wrong password. After 5 unsuccessful attempts the user should be suspended. You shouldreceive the below message on the 6th attempt. On the VAULT01A server, open the PrivateArk Client using the shortcut in the Windows task bar. Login as Administrator (PrivateArk Authentication). Navigate to Tools -> Administrative Tools -> Users and groups. Locate the Vaultadmin01 user. Click on Trusted Net Areas. Then click on Activate to unsuspend Vaultadmin01. page 176 The user should now appear as Active. Click on Close and then log off the PrivateArk Client. Open the PVWA and try to login as Vaultadmin01, this time using the correct password (Cyberark1). Verify you can now login as Vaultadmin01. page 177 RecoveryPrvKey=”C:\\CYBR_Files\\Licence and Operator Keys\\Master CD\\recprv.key” Important: You don’t need to do anything here, but in a real environment, you would have to retrieve the Master CD from a physical safe, load it into the Vault server, and only then be able to connect to the Vault as Master. Question: How many safes are listed? Question: How many safes are listed? Log in with Master There are some cases where you will need to log in to the Vault with the Master user. Thiscan be in the event of an emergency or to give permissions to a user for a Safe when there are no active users with the necessary permissions. To use the Master user, the dbparm.ini file must point to the location of the RecoveryPrivate Key. By default, this is the CD-ROM drive of the server. On the Vault01A server, open C:\\Program Files (x86)\\PrivateArk\\Server\\Conf\\dbparm.ini. Because we do not have a CD-ROM drive (we are using VMs for our lab exercises),The RecoveryPrvKey parameter has been changed in the training environment to point to the location of the file called recprv.key in the Master CD folder: Open the PrivateArk Client from the Vault server machine. Delete the username Administrator and enter: Master. The password is Cyberark1.These values were set during installation. Log off the PrivateArk Client session and log in as Administrator You should notice that there are more safes displayed when you are logged in as the Master user. page 178 Reports In this section you will be asked to create three types of reports. Generate “Privileged Accounts Inventory” report Login to the PVWA asVaultadmin01 and go to the Reports pane. Click on Generate Report. Click Next to generate the “Privileged Accounts Inventory” report. Review the options to filter the report, but keep the default values, then click Next. page 179 Click Finish to generate the report. Select the refresh icon at the bottom of the page until the report status shows “Done”. Open the report by clicking on the Excel icon. Click OK to open with the default LibreOffice Calc. page 180 After going over the report, save the new report to the desktop of the Components server. If you are asked if you want to save the document in its current format, click Keep Current Format. Generate “Safes List” Report and “Users List” report On the Comp01A server, open the PrivateArk Client and login as vaultadmin01 (using LDAP authentication) Under Tools -> Reports, click on Safes List to generate a safes list report page 181 Click the Report Output tab and save the new report to the desktop of theComponents server. page 182 Objective: Configure component CyberArk Replicate to backup the vault to a remote server. Note: Ensure that all Virtual Machines(VM’s) are started in your Skytap lab before proceeding (except for the DR VM). CyberArk Vault Backup Enable the Backup and DR Users For this section of the exercise, you will first login to the PrivateArk Client on Comp01A Server. 1. Use the PrivateArk client to log into the Vault as administrator (use the PSM- PrivateArk Clientconnection component). 2. Go to Tools > Administrative Tools > Users and Groups. … 3. Highlight the Backup user (located under System) and press Update. 4. On the General tab deselect the Disable User checkbox. page 183 Note: The DR user will be used in the coming Disaster Recovery exercise. As such we will enable it now. 5. On the Authentication tab enter Cyberark1 in the Password and Confirm fields. 6. Press OK. 7. Highlight the DR user (located under System) and press Update. page 184 8. On the General tab uncheck the Disable User checkbox. 9. On the Authentication tab enter Cyberark1 in the Password and Confirm fields. Click OK thenLogoff the PrivateArk Client. page 185 Install the PrivateArk Replicator Component 1. Sign in to the Comp01A Server, open Windows File Explorer and navigate to the shared resource folder, “Z:\\. If the Z: drive is not mapped, map Z: to \\\\dc01\\shared. 2. Navigate to “Z:\\CyberArk PAM Solution\\v12.1\\”. Copy the file ‘Replicate-Rls- v12.1.zip’ to “C:\\CYBR_Files” and extract all files. 3. Navigate to extracted folder “‘C:\\CYBR_Files\\ Replicate-Rls-v12.1”, and right click and “Run As Administrator” setup.exe. 4. Accept all the default parameters to complete the installation. On the Welcome screen enter Next and click Yes to accept the license agreement. 5. Enter ACME Corp for the user and company names and click Next, and Next again to accept thedefault destination location. page 186 Objective: Create a credential file that the Replicator Component will use to authenticate to the CreateCredFile.exe user.ini Vault Username [mandatory] ==> Backup Vault Password…==> Cyberark1 Select “Restrict to current machine IP (yes) Display Restrictions in output file (yes) 6. Press Next to accept the default Safes location and click Finish to complete the installation. 7. In Windows File Explorer, navigate to C:\\Program Files (x86)\\PrivateArk\\Replicate. 8. Edit the Vault.ini file and enter the IP address of your Vault server in the address parameter. 9. Save and close the file. 10. Open “Windows PowerShell” in the Replicate root installation directory, “C:\\ProgramFiles (x86)\\PrivateArk\\Replicate”. 11. Use the CreateCredfile.exe utility to create the user.ini credential file with the following options: page 187 Objective: Create a Windows Scheduled Task to launch PAReplicate and backup the vault data on a schedule. “C:\\Program Files (x86)\\PrivateArk\\Replicate\\PAReplicate.exe” vault.ini /logonfromfile user.ini /FullBackup C:\\Program Files (x86)\\PrivateArk\\Replicate Note: You can check the status of the job by scrolling to the right and refreshing column ‘Last Run Result’ Note: The first time running PAReplicate with the /FullBackup argument may take an extended amount of time in a Production environment depending on the number and size of accounts and PSM recordings. Subsequent Full Backups will only backup changed files, equivalent to an incremental backup. 12. Press Enter to accept the defaults for all other questions. Create a Windows Scheduled Task 1. Open the “Task Scheduler” application from the Windows Start Menu > Administrative Toolsmenu. Select Task Scheduler Library, right click and select Create a Basic Task. a. In the Name field type ‘CyberArk Vault Full Backup’ and click Next. b. Task Trigger select Daily and click Next. c. Accept the default start date and time and click Next. d. Action: Select ‘Start a program’ and select Next. e. Start a Program: Program/script: field enter the following including double quotes. f. Enter the following without double quotes in the ‘Arguments (optional):’ field. g. Enter the following without double quotes in the ‘Start in (optional):’ field 2. Click Next and Finish at the Summary. 3. Double click the ‘CyberArk Vault Full Backup’ from the Task Scheduler Library. 4. In Security options, Change the User or Group to ‘System’ and click Ok. 5. Select the ‘CyberArk Vault Full Backup’ from the Task Scheduler Library, right click on it and select ‘Run’. 6. You can also run the command from a command line as follows, as an initial test. 7. Review the PAReplicate.log file located in the \\Replicate root directory. page 188 Testing the Backup/Restore Process 1. Login to the PVWA as Vaultadmin01. 2. Go to POLICIES > Access Control (Safes). 3. Select your Linux accounts safe and Delete it. 4. Press Yes to confirm that you would like to delete the Safe and its contents. 5. You will receive a message that the Root folder cannot be deleted for 7 days. However, thecontents of the Safe will be removed. 6. To confirm that the contents of the Safe have been deleted, go to the Accounts page. 7. Enter root01 in the search box and press the Search button and confirm that the root account thatyou created earlier in this exercise using address 10.0.0.21, will not appear. page 189 PARestore.exe vault.ini dr /RestoreSafe “Linux Accounts” /TargetSafe LinuxRestore Note: If the command doesn’t run, check the syntax and make sure you have entered all the spaces correctly. 8. Open a PowerShell Window in ‘C:\\Program Files (x86)\\PrivateArk\\Replicate’ and run the following: 9. Enter the DR user’s password (Cyberark1). 10. You should receive a message “PARST012I Restore process of Vault Restore (10.0.10.1) ended…” 11. Return to the PVWA as Vaultadmin01 and search for root01 again. 12. You should now see the root01 account residing in the Safe LinuxRestore. page 190 Objective: In this section we will install and test the Disaster Recovery module. Prior to installing the CyberArk Disaster Recovery software, the DR server must have the Private Ark Server installed. Note: The PrivateArk Server and Client software has already been installed on your DR server. IMPORTANT: Ensure that the DR VM is running in your Skytap lab before proceeding. Note: If you have completed the CyberArk Vault Backup exercise, the DR user has already been enabled. If you did not enable the DR user, do it now. Note: The DR Vault must be configured to support LDAP Authentication. The import of the CA Root Certificate and the Hosts file configuration has been updated for you. Note: The only Safes in the Vault should be the three built-in Safes. Disaster Recovery Install the Disaster Recovery Module 1. Sign into the Disaster Recovery Vault server (DR) as Administrator. 2. Open the Server Central Administration app from the Desktop icon labeled ‘PrivateArk Server’ toconfirm the version of the DR Digital Vault is identical to the version installed on the Primary Digital Vault Server. a. Look for the message “ITADB313I Server (12.1.0.9) is up” b. Close the Server Central Administration application. 3. Open the PrivateArk client and login to the DRVault (10.0.14.1) as administrator. page 191 4. Logoff and close the PrivateArk Client application. 5. Open the Windows Services applet and stop the PrivateArk Server service. 6. Open File Explorer and navigate to “C:\\CYBR_Files\\Vault Installation Files/Disaster Recovery”. 7. Right click setup.exe and “Run as administrator”. 8. Press Next on the welcome screen and Yes to accept the license agreement. 9. Enter “ACME Corp” in the Company field. 10. Click Next to accept the default destination folder. 11. Enter DR as the user and Cyberark1 as the password and click Next. 12. Enter your Primary Vault IP Address (10.0.10.1) and click Next, 13. Allow the server to restart by pressing Finish. page 192 Validate Replication 1. After the server restarts, sign in to the DR Server as Administrator. 2. Confirm that the production Vault replicated successfully. a. Open the C:\\Program Files (x86)\\PrivateArk\\PADR\\Logs\\PADR.log file, you should see entrieswith informational codes PAREP013I Replicating Safe and at the end, PADR0010I Replicate ended. 3. Open \\Conf\\PADR.INI file and note that FailoverMode is equal to No.Execute Automatic FailoverTest page 193 Objective: Execute Failover procedures. 1. Sign in to the PVWA on Comp01A/B. Find the built-in Administrator for the Vault and launch thePSM-PrivateArk Client Connection Component. 2. Select menu item Tools > Administrative Tools > Users and Groups then select the System folder. 3. Select New > User and configure the following ‘General Details’ a. User Name: DR_Failback b. User type: DR_Users c. Select the ‘Authentication’ tab and set the password to ‘Cyberark1’. d. Deselect ‘User Must Change Password at Next Logon and select Password Never Expires. e. Select Authorizations tab and select Backup All Safes and Restore All Safes. f. Select the ‘Member Of’ tab. From the ‘Available Groups:’ column on the right, select ‘DRUsers’ and move to the ‘Member Of:’ column on the left. 4. Click OK to save. Close the ‘Users and Groups’ window and sign out of the PrivateArk Client. 5. Sign in to the DR Vault server console and restart the CyberArk Vault Disaster Recovery Serviceusing the Windows Services Applet. This will ensure that the new DR_Failback user has been replicated to the DR Vault. a. Check the PADR.LOG file to ensure that replication is working correctly. 1. Sign in to the console of your Primary Vault server, Vault01A. 2. Open the Windows Services applet and stop the PrivateArk Server service. Preparation: In the following procedures you will be guided through the process of failover and failback, replicating Vault data to and from the DR Vault. This requires an additional DR user that you must create on the Primary Vault so that it is available on the DR Vault when needed. Note: The following procedure requires additional licensing to support a second DR user. page 194 Get-Content .\\logs\\padr.log –wait 3. On the console of the DR Server, open the PADR log file. You should see messages stating that the DR Vault cannot reach the production Vault. 4. Alternatively, follow the tail of the padr.log using Windows Powershell. 5. Open Windows PowerShell from the taskbar. 6. Change directories to “C:\\Program Files (x86)\\PrivateArk\\PADR” 7. Type the following command 8. After 5 failures by default, the DR Vault will go into failover mode. Total duration = 5 minutes.Check the PADR.log and review the sequence of events. page 195 Note: The built-in Administrator user is now being managed by the CPM and the password has been changed and replicated to the DR Vault. In the event of an actual disaster, the built-in Administrators password may not be accessible and so it is important to configure the DR Vault to support LDAP Authentication for administrative and normal Note: The Safes and data should match those in the Primary Vault. 9. On the DR Vault server, open the PrivateArk client. 10. Modify the properties of the DRVault (10.0.14.1) shortcut to require LDAP Authentication. Login asVaultAdmin01. 11. Logoff the PrivateArk Client. page 196 Objective: Replicate data back from the DR Vault to the Primary Vault, perform a Manual Failover to the Primary Vault and set the DR server back to DR mode. Execute Failback Procedure Using Manual Failover 1. Sign in to the Primary Vault Server and repeat the steps for Installing the DR module, this timeconfiguring the DR module to replicate data from the DR Vault. a. Enter DR_Failback in the DR user with password ‘Cyberark1’. b. Enter the DR Vaults IP Address. page 197 2. After the server restart, review the PADR.LOG on vault01a to verify that the Primary Vault hasreplicated all changes, if any from the DR Vault. 3. On the Primary Vault Server edit the PADR.ini file. a. Set EnableFailover=No b. Add the following line: ActivateManualFailover=Yes c. Save the file and exit. 4. Restart the ‘CyberArk Vault Disaster Recovery’ Service on the Primary Server. The service should start and stop immediately (because of the “ActivateManualFailover” parameter), then the ‘PrivateArk Server’ service should start. Verify that the PrivateArk Server service has started successfully on the Primary Vault server. page 198 a. Wait a few minutes. If the PrivateArk Server service does not start automatically, start theservice manually. 5. On the DR Vault server edit the PADR.ini file. a. Change Failover mode from Yes to No. b. Delete the last two lines (log number and timestamp of the last successful replication) in thefile This will trigger a full replication. c. Save and exit the file. 6. Using the Windows Services applet, stop the PrivateArk Server service and Start the CyberArkVault Disaster Recovery service. page 199 7. Check the PADR log file and confirm that the replication process started and that the replication(from the Primary Server to the DR Server) has ended successfuly. page 200 Just-in-Time (JIT) Access A major step in the Privilege Access Management program is to secure the Windows local administrators. This is essential to reduce the risk of lateral movement. CyberArk enables securing local administrator credentials, as well as using PSM to access those accounts. There are cases, however, where managing the local administrator passwords is not possible at the initial stage of deployment, whether because of objection from the IT users,or other reasons. Just-in- Time (JIT) access allows you to gain control over local administrator security without inconveniencing administrative users. It can be used as an intermediate step towards full implementation of Vaulting the local administrator accounts. You can grant Windows admins on-demand, ad-hoc privileged access to Windows targets,for a predefined number of hours (4 hours by default). During this time, domain users can request to access a system as a local administrator. If authorized, the system temporarily adds the logged-on Windows users into the target system's local administrator group, without the need to manage the credentials of the localadministrator on that target. This allows for a frictionless and lightweight solution that enables your organization to introduce privileged controls and help establish habitual security, before moving into a robust PAM program. The workflow, as exhibited in the following diagram, starts when an end user requests access to a designated target machine and then is added to the local admin groups. The end user is notified that they have been granted access (or not), and once granted, is ableto access the target machine using their own login for 4 hours (by default). After this period, the user is automatically removed from the local admin group. page 201 Set up the JIT Access Platform In this exercise, you will set up Just-in-Time access for the Windows admin user (John), allowing John to be added to the local admin group on the target system for 4 hours. Log into the PVWA as mike. Go to ADMINISTRATION -> Platform Management and duplicate the WIN SRVLCL ADM 45 Platform to a new platform called WIN SRV JIT. You may add a description stating accounts associated with this platform are not managed by theCPM. Click on Edit to edit the new platform. In the new platform set the following parameters to NO. • UI & Workflows • AutoChangeOnAdd • Automatic Password Management -> Password Change • AllowManualChange • PerformPeriodicChange • Automatic Password Management -> Password Verification • VFAllowManualVerification • VFPerformPeriodicVerification page 202 • Automatic Password Management -> Password Reconciliation • RCAllowManualReconciliation • RCAutomaticReconcileWhenUnsynched In the new platform, go to UI & Workflows -> Properties. Remove the Username property from Required, and add a new property called Username under Optional. In the new Platform, right-click on Automatic Password Management, and select Additional Policy Settings. Under Additional Policy Settings, set AllowDomainUserAdHocAccess to Yes. page 203 Note: For JIT access, a domain account that has been configured as a reconcile account should be associated with the platform. In our case, this has already been defined in the base platform we duplicated: WIN SRV LCL ADM 45 Note: For security best practice, you need to limit the Safes that are required for ad hoc access, by setting the AllowedSafes parameter with a regular expression that liststhe Safes that this platform can be applied to. This too has already been defined in the base platform we duplicated: WIN SRV LCL ADM 45 Note: You can also set the time, in minutes, after which a user is automatically removedfrom the Administrators group on the target machine. By default, the parameter is set to 240 minutes (4 hours). You will see a pop-up dialog warning you to use the AllowedSafes parameter to limitthe use of this policy to only those Safes where it is appropriate. Click Yes. Add the Local Administrator Account Go to Accounts View and click on Add Account. Add the local administrator account of the Target Windows server: page 204 System Type: Windows Assign to Platform: WIN SRV JIT Store in Safe: Win-Srv-Fin-US Address: 10.0.22.1 User Name: Administrator Password: Cyberark1 Confirm Password: Cyberark1 Logon To (optional): <click the Resolve button> TARGET-WIN Test Just-in-Time Access First, open MSTSC (you can use the search functionality to find the application). Attempt to connect to target-win.acme.corp as acme\\John page 205 You should receive an error stating that John is not authorized for remote login: Now, login to the PVWA as John. Search for the Target Windows local Administrator account and click on Get Access. If you configured everything successfully, you should receive a notification sayingyou’ve been granted admin access for 4 hours. Now try to launch another RDP connection to the Target Windows server as acme\\John. You should be able to login this time. After successfully connecting to the Target Windows server, go to Computer Management -> Local Users and Groups -> Groups and open the local Administrators group. Verify that acme\\John was added to the group. Disconnect from the Target Windows server. page 206","libVersion":"0.2.2","langs":""}